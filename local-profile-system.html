<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Local Profile System</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-50 p-4">
    <div class="max-w-4xl mx-auto">
        <h1 class="text-2xl font-bold mb-6">üóÇÔ∏è Local Profile System</h1>
        
        <!-- Local Storage Information -->
        <div class="bg-blue-50 border border-blue-300 rounded-lg p-4 mb-6">
            <div class="flex items-start">
                <div class="flex-shrink-0">
                    <svg class="h-5 w-5 text-blue-600 mt-0.5" fill="currentColor" viewBox="0 0 20 20">
                        <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path>
                    </svg>
                </div>
                <div class="ml-3">
                    <h3 class="text-sm font-medium text-blue-900">üîí Your data stays on your device - no account needed!</h3>
                    <p class="text-sm text-blue-800 mt-1">
                        Profiles are saved in your browser's local storage for privacy and convenience. Export your profiles to back them up or share between devices.
                    </p>
                    <ul class="text-xs text-blue-700 mt-2 space-y-1">
                        <li>‚Ä¢ All data is stored locally in your browser</li>
                        <li>‚Ä¢ No data is sent to any server</li>
                        <li>‚Ä¢ Clear browser data will remove profiles (use export to backup)</li>
                        <li>‚Ä¢ Each browser/device maintains its own profiles</li>
                    </ul>
                </div>
            </div>
        </div>
        
        <!-- Profile Management Panel -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-lg font-bold mb-4">Profile Management</h2>
            
            <!-- Profile Input and Save -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-4">
                <div>
                    <label for="profile-name" class="block text-sm font-medium text-gray-700 mb-1">Profile Name</label>
                    <input type="text" id="profile-name" placeholder="e.g., My GEM e4, Weekend Cart"
                           class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                </div>
                
                <div class="flex items-end">
                    <button id="save-settings-btn" class="w-full px-4 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 transition-colors">
                        üíæ Save Current Settings
                    </button>
                </div>
                
                <div>
                    <label for="profile-dropdown" class="block text-sm font-medium text-gray-700 mb-1">Load Profile</label>
                    <select id="profile-dropdown" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <option value="">Select profile to load...</option>
                    </select>
                </div>
                
                <div class="flex items-end">
                    <button id="delete-profile-btn" class="w-full px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 transition-colors" disabled>
                        üóëÔ∏è Delete Profile
                    </button>
                </div>
            </div>
            
            <!-- Export/Import Controls -->
            <div class="flex flex-wrap gap-3 pt-4 border-t border-gray-200">
                <button id="export-profiles-btn" class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                    üì§ Export All Profiles
                </button>
                <button id="import-profiles-btn" class="px-4 py-2 bg-purple-600 text-white rounded-md hover:bg-purple-700 transition-colors">
                    üì• Import Profiles
                </button>
                <input type="file" id="import-file" accept=".json" class="hidden">
                
                <div class="ml-auto text-sm text-gray-500 flex items-center">
                    <span id="profile-count">0 profiles saved</span>
                </div>
            </div>
        </div>

        <!-- Vehicle Configuration Form (Demo) -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-lg font-bold mb-4">Vehicle Configuration (Demo Form)</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                <!-- Column 1: Vehicle Details -->
                <div class="space-y-3">
                    <h3 class="font-medium text-gray-800">Vehicle Details</h3>
                    
                    <div>
                        <label for="vehicle-model" class="text-sm font-medium text-gray-700">Model</label>
                        <select id="vehicle-model" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded">
                            <option value="">Select...</option>
                            <option value="e2">e2 (2-passenger)</option>
                            <option value="e4">e4 (4-passenger)</option>
                            <option value="e6">e6 (6-passenger)</option>
                            <option value="eS">eS (2-passenger utility)</option>
                            <option value="eL">eL (4-passenger utility)</option>
                            <option value="eM">eM (Mighty Mite)</option>
                        </select>
                    </div>

                    <div>
                        <label for="vehicle-year" class="text-sm font-medium text-gray-700">Year</label>
                        <select id="vehicle-year" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded">
                            <option value="">Select...</option>
                            <option value="2020+">2020+</option>
                            <option value="2016-2019">2016-2019</option>
                            <option value="2010-2015">2010-2015</option>
                            <option value="2005-2009">2005-2009</option>
                            <option value="1999-2004">1999-2004</option>
                            <option value="pre-1999">Pre-1999</option>
                        </select>
                    </div>

                    <div>
                        <label for="controller-type" class="text-sm font-medium text-gray-700">Controller</label>
                        <select id="controller-type" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded">
                            <option value="">Select...</option>
                            <option value="T2">T2</option>
                            <option value="T4">T4</option>
                            <option value="T1">T1 (Legacy)</option>
                            <option value="unknown">Not Sure</option>
                        </select>
                    </div>

                    <div>
                        <label for="current-speed" class="text-sm font-medium text-gray-700">Current Top Speed</label>
                        <div class="mt-1 relative">
                            <input type="number" id="current-speed" min="15" max="40" placeholder="25"
                                   class="w-full px-2 py-1.5 pr-12 text-sm border border-gray-300 rounded">
                            <span class="absolute inset-y-0 right-0 pr-2 flex items-center text-xs text-gray-500">MPH</span>
                        </div>
                    </div>
                </div>

                <!-- Column 2: Motor & Battery -->
                <div class="space-y-3">
                    <h3 class="font-medium text-gray-800">Motor & Battery</h3>
                    
                    <div>
                        <label for="motor-type" class="text-sm font-medium text-gray-700">Motor Type</label>
                        <select id="motor-type" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded">
                            <option value="">Select...</option>
                            <option value="dc-stock">DC Stock (3.5HP)</option>
                            <option value="dc-upgrade">DC Upgrade (5HP+)</option>
                            <option value="ac-stock">AC Stock</option>
                            <option value="ac-performance">AC Performance</option>
                            <option value="custom">Custom</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="battery-voltage" class="text-sm font-medium text-gray-700">Battery Voltage</label>
                        <select id="battery-voltage" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded">
                            <option value="">Select...</option>
                            <option value="48">48V</option>
                            <option value="60">60V</option>
                            <option value="72">72V</option>
                            <option value="82">82V</option>
                            <option value="96">96V</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="battery-type" class="text-sm font-medium text-gray-700">Battery Type</label>
                        <select id="battery-type" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded">
                            <option value="">Select...</option>
                            <option value="lead-acid">Lead Acid</option>
                            <option value="agm">AGM</option>
                            <option value="gel">Gel</option>
                            <option value="lithium">Lithium</option>
                        </select>
                    </div>
                    
                    <div>
                        <label for="battery-capacity" class="text-sm font-medium text-gray-700">Battery Capacity</label>
                        <div class="mt-1 relative">
                            <input type="number" id="battery-capacity" min="50" max="500" step="5" placeholder="105"
                                   class="w-full px-2 py-1.5 pr-10 text-sm border border-gray-300 rounded">
                            <span class="absolute inset-y-0 right-0 pr-2 flex items-center text-xs text-gray-500">Ah</span>
                        </div>
                    </div>
                </div>

                <!-- Column 3: Drivetrain -->
                <div class="space-y-3">
                    <h3 class="font-medium text-gray-800">Drivetrain</h3>
                    
                    <div>
                        <label for="tire-diameter" class="text-sm font-medium text-gray-700">Tire Diameter</label>
                        <div class="mt-1 relative">
                            <input type="number" id="tire-diameter" min="18" max="26" step="0.5" placeholder="22.5"
                                   class="w-full px-2 py-1.5 pr-8 text-sm border border-gray-300 rounded">
                            <span class="absolute inset-y-0 right-0 pr-2 flex items-center text-xs text-gray-500">in</span>
                        </div>
                    </div>
                    
                    <div>
                        <label for="gear-ratio" class="text-sm font-medium text-gray-700">Gear Ratio</label>
                        <input type="text" id="gear-ratio" placeholder="10.35:1" pattern="[0-9]+\.?[0-9]*:1"
                               class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded">
                    </div>
                    
                    <div>
                        <label for="differential" class="text-sm font-medium text-gray-700">Differential</label>
                        <select id="differential" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded">
                            <option value="">Select...</option>
                            <option value="standard">Standard</option>
                            <option value="limited-slip">Limited Slip</option>
                            <option value="locked">Locked</option>
                        </select>
                    </div>

                    <div>
                        <label for="modifications" class="text-sm font-medium text-gray-700">Modifications</label>
                        <textarea id="modifications" placeholder="List any modifications..."
                                  class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded resize-vertical"
                                  rows="3"></textarea>
                    </div>
                </div>
            </div>
        </div>

        <!-- Saved Profiles Display -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
            <h2 class="text-lg font-bold mb-4">Saved Profiles</h2>
            <div id="profiles-display" class="space-y-3">
                <!-- Profiles will be populated here -->
            </div>
            <div id="no-profiles-message" class="text-center text-gray-500 py-8">
                <div class="text-4xl mb-2">üìÅ</div>
                <div>No profiles saved yet</div>
                <div class="text-sm mt-1">Fill out the form above and save your first profile</div>
            </div>
        </div>

        <!-- Status and Debug Log -->
        <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6">
            <h2 class="text-lg font-bold mb-4">System Status</h2>
            <div id="status-log" class="bg-gray-100 p-3 rounded text-sm font-mono max-h-64 overflow-y-auto">
                Local profile system initialized...
            </div>
        </div>
    </div>

    <script>
        /**
         * Local Profile Management System
         * No authentication required - all data stored in localStorage
         */
        class LocalProfileSystem {
            constructor() {
                this.storageKey = 'gem_local_profiles';
                this.profileFields = [
                    'vehicle-model', 'vehicle-year', 'controller-type', 'current-speed',
                    'motor-type', 'battery-voltage', 'battery-type', 'battery-capacity',
                    'tire-diameter', 'gear-ratio', 'differential', 'modifications'
                ];
                this.init();
            }

            init() {
                this.setupEventListeners();
                this.updateProfileDropdown();
                this.updateProfilesDisplay();
                this.updateProfileCount();
                this.log('Local profile system initialized');
            }

            setupEventListeners() {
                // Save current settings
                document.getElementById('save-settings-btn').addEventListener('click', () => {
                    this.saveCurrentSettings();
                });

                // Profile dropdown change
                document.getElementById('profile-dropdown').addEventListener('change', (e) => {
                    const profileId = e.target.value;
                    if (profileId) {
                        this.loadProfile(profileId);
                        document.getElementById('delete-profile-btn').disabled = false;
                    } else {
                        document.getElementById('delete-profile-btn').disabled = true;
                    }
                });

                // Delete profile
                document.getElementById('delete-profile-btn').addEventListener('click', () => {
                    const selectedProfile = document.getElementById('profile-dropdown').value;
                    if (selectedProfile) {
                        this.deleteProfile(selectedProfile);
                    }
                });

                // Export profiles
                document.getElementById('export-profiles-btn').addEventListener('click', () => {
                    this.exportProfiles();
                });

                // Import profiles
                document.getElementById('import-profiles-btn').addEventListener('click', () => {
                    document.getElementById('import-file').click();
                });

                document.getElementById('import-file').addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        this.importProfiles(file);
                    }
                });

                // Clear import file input after use
                document.getElementById('import-file').addEventListener('click', (e) => {
                    e.target.value = '';
                });
            }

            saveCurrentSettings() {
                const profileName = document.getElementById('profile-name').value.trim();
                
                if (!profileName) {
                    this.showNotification('Please enter a profile name', 'error');
                    document.getElementById('profile-name').focus();
                    return;
                }

                // Get current form data
                const profileData = this.getCurrentFormData();
                
                // Check if we have any data to save
                const hasData = Object.values(profileData).some(value => value && value.trim() !== '');
                if (!hasData) {
                    this.showNotification('No configuration data to save', 'warning');
                    return;
                }

                // Generate unique ID
                const profileId = Date.now().toString();
                
                // Create profile object
                const profile = {
                    id: profileId,
                    name: profileName,
                    data: profileData,
                    createdAt: new Date().toISOString(),
                    lastModified: new Date().toISOString()
                };

                // Save to localStorage
                const profiles = this.getProfiles();
                profiles[profileId] = profile;
                this.saveProfiles(profiles);

                // Update UI
                this.updateProfileDropdown();
                this.updateProfilesDisplay();
                this.updateProfileCount();
                
                // Clear profile name input
                document.getElementById('profile-name').value = '';
                
                this.showNotification(`Profile "${profileName}" saved successfully!`, 'success');
                this.log(`Saved profile: ${profileName} (ID: ${profileId})`);
            }

            loadProfile(profileId) {
                const profiles = this.getProfiles();
                const profile = profiles[profileId];

                if (!profile) {
                    this.showNotification('Profile not found', 'error');
                    return;
                }

                // Load data into form fields
                Object.entries(profile.data).forEach(([fieldId, value]) => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = value || '';
                    }
                });

                this.showNotification(`Profile "${profile.name}" loaded!`, 'success');
                this.log(`Loaded profile: ${profile.name} (ID: ${profileId})`);
            }

            deleteProfile(profileId) {
                const profiles = this.getProfiles();
                const profile = profiles[profileId];

                if (!profile) {
                    this.showNotification('Profile not found', 'error');
                    return;
                }

                if (!confirm(`Are you sure you want to delete the profile "${profile.name}"?`)) {
                    return;
                }

                // Remove from storage
                delete profiles[profileId];
                this.saveProfiles(profiles);

                // Update UI
                this.updateProfileDropdown();
                this.updateProfilesDisplay();
                this.updateProfileCount();
                
                // Reset dropdown and disable delete button
                document.getElementById('profile-dropdown').value = '';
                document.getElementById('delete-profile-btn').disabled = true;

                this.showNotification(`Profile "${profile.name}" deleted`, 'success');
                this.log(`Deleted profile: ${profile.name} (ID: ${profileId})`);
            }

            exportProfiles() {
                const profiles = this.getProfiles();
                const profileCount = Object.keys(profiles).length;

                if (profileCount === 0) {
                    this.showNotification('No profiles to export', 'warning');
                    return;
                }

                // Create export data
                const exportData = {
                    exportVersion: '1.0',
                    exportDate: new Date().toISOString(),
                    profileCount: profileCount,
                    profiles: profiles
                };

                // Create and download file
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                
                const link = document.createElement('a');
                link.href = URL.createObjectURL(dataBlob);
                link.download = `gem-profiles-backup-${new Date().toISOString().split('T')[0]}.json`;
                
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                URL.revokeObjectURL(link.href);

                this.showNotification(`Exported ${profileCount} profiles successfully!`, 'success');
                this.log(`Exported ${profileCount} profiles to file`);
            }

            async importProfiles(file) {
                try {
                    const text = await file.text();
                    const importData = JSON.parse(text);

                    // Validate import data structure
                    if (!importData.profiles || typeof importData.profiles !== 'object') {
                        throw new Error('Invalid file format - missing profiles data');
                    }

                    const importedProfiles = importData.profiles;
                    const importCount = Object.keys(importedProfiles).length;

                    if (importCount === 0) {
                        this.showNotification('No profiles found in import file', 'warning');
                        return;
                    }

                    // Ask user how to handle existing profiles
                    const existingProfiles = this.getProfiles();
                    const existingCount = Object.keys(existingProfiles).length;
                    
                    let shouldMerge = true;
                    if (existingCount > 0) {
                        shouldMerge = confirm(
                            `You have ${existingCount} existing profiles.\n\n` +
                            `Click OK to merge with ${importCount} imported profiles.\n` +
                            `Click Cancel to replace all existing profiles.`
                        );
                    }

                    // Import profiles
                    let finalProfiles = {};
                    if (shouldMerge) {
                        finalProfiles = { ...existingProfiles };
                    }

                    // Add imported profiles (with new IDs to avoid conflicts)
                    Object.values(importedProfiles).forEach(profile => {
                        const newId = Date.now().toString() + Math.random().toString(36).substr(2, 5);
                        finalProfiles[newId] = {
                            ...profile,
                            id: newId,
                            lastModified: new Date().toISOString()
                        };
                    });

                    // Save and update UI
                    this.saveProfiles(finalProfiles);
                    this.updateProfileDropdown();
                    this.updateProfilesDisplay();
                    this.updateProfileCount();

                    const action = shouldMerge ? 'merged' : 'imported';
                    this.showNotification(`Successfully ${action} ${importCount} profiles!`, 'success');
                    this.log(`Imported ${importCount} profiles from file (${action})`);

                } catch (error) {
                    this.showNotification(`Import failed: ${error.message}`, 'error');
                    this.log(`Import failed: ${error.message}`);
                }
            }

            getCurrentFormData() {
                const data = {};
                this.profileFields.forEach(fieldId => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        data[fieldId] = field.value || '';
                    }
                });
                return data;
            }

            getProfiles() {
                try {
                    const stored = localStorage.getItem(this.storageKey);
                    return stored ? JSON.parse(stored) : {};
                } catch (error) {
                    this.log(`Error loading profiles: ${error.message}`);
                    return {};
                }
            }

            saveProfiles(profiles) {
                try {
                    localStorage.setItem(this.storageKey, JSON.stringify(profiles));
                } catch (error) {
                    this.log(`Error saving profiles: ${error.message}`);
                    this.showNotification('Failed to save profiles to localStorage', 'error');
                }
            }

            updateProfileDropdown() {
                const dropdown = document.getElementById('profile-dropdown');
                const profiles = this.getProfiles();
                
                // Clear existing options (except the first one)
                dropdown.innerHTML = '<option value="">Select profile to load...</option>';
                
                // Add profile options
                Object.values(profiles)
                    .sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified))
                    .forEach(profile => {
                        const option = document.createElement('option');
                        option.value = profile.id;
                        option.textContent = profile.name;
                        dropdown.appendChild(option);
                    });
            }

            updateProfilesDisplay() {
                const display = document.getElementById('profiles-display');
                const noProfilesMsg = document.getElementById('no-profiles-message');
                const profiles = this.getProfiles();
                const profileList = Object.values(profiles);

                if (profileList.length === 0) {
                    display.classList.add('hidden');
                    noProfilesMsg.classList.remove('hidden');
                    return;
                }

                display.classList.remove('hidden');
                noProfilesMsg.classList.add('hidden');

                // Sort by last modified (newest first)
                profileList.sort((a, b) => new Date(b.lastModified) - new Date(a.lastModified));

                display.innerHTML = profileList.map(profile => {
                    const data = profile.data;
                    const configSummary = [
                        data['vehicle-model'] && `Model: ${data['vehicle-model']}`,
                        data['vehicle-year'] && `Year: ${data['vehicle-year']}`,
                        data['battery-voltage'] && `Battery: ${data['battery-voltage']}V`,
                        data['controller-type'] && `Controller: ${data['controller-type']}`
                    ].filter(Boolean).join(' ‚Ä¢ ') || 'No configuration details';

                    return `
                        <div class="border border-gray-200 rounded-lg p-4 hover:bg-gray-50 transition-colors">
                            <div class="flex justify-between items-start">
                                <div class="flex-grow">
                                    <h3 class="font-medium text-gray-900">${profile.name}</h3>
                                    <div class="text-sm text-gray-600 mt-1">${configSummary}</div>
                                    <div class="text-xs text-gray-500 mt-1">
                                        Created: ${new Date(profile.createdAt).toLocaleDateString()} ‚Ä¢ 
                                        Modified: ${new Date(profile.lastModified).toLocaleDateString()}
                                    </div>
                                </div>
                                <div class="flex space-x-2 ml-4">
                                    <button onclick="profileSystem.loadProfile('${profile.id}')" 
                                            class="px-3 py-1 bg-blue-600 text-white text-xs rounded hover:bg-blue-700 transition-colors">
                                        Load
                                    </button>
                                    <button onclick="profileSystem.deleteProfile('${profile.id}')" 
                                            class="px-3 py-1 bg-red-600 text-white text-xs rounded hover:bg-red-700 transition-colors">
                                        Delete
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
            }

            updateProfileCount() {
                const profiles = this.getProfiles();
                const count = Object.keys(profiles).length;
                const countElement = document.getElementById('profile-count');
                countElement.textContent = `${count} profile${count !== 1 ? 's' : ''} saved`;
            }

            showNotification(message, type = 'info') {
                // Check storage space for error messages
                if (type === 'error' && (message.includes('storage') || message.includes('save') || message.includes('failed'))) {
                    this.checkStorageSpace();
                }
                
                const notification = document.createElement('div');
                notification.className = `fixed top-4 right-4 z-50 px-4 py-3 rounded-md text-sm max-w-sm shadow-lg ${
                    type === 'success' ? 'bg-green-100 text-green-800 border border-green-200' :
                    type === 'error' ? 'bg-red-100 text-red-800 border border-red-200' :
                    type === 'warning' ? 'bg-yellow-100 text-yellow-800 border border-yellow-200' :
                    'bg-blue-100 text-blue-800 border border-blue-200'
                }`;
                
                const icon = type === 'success' ? '‚úÖ' : type === 'error' ? '‚ùå' : type === 'warning' ? '‚ö†Ô∏è' : '‚ÑπÔ∏è';
                notification.innerHTML = `<div class="flex items-start"><span class="mr-2">${icon}</span><span>${message}</span></div>`;
                
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 4000);
            }
            
            /**
             * Check available storage space and show warning if low
             */
            async checkStorageSpace() {
                try {
                    if ('storage' in navigator && 'estimate' in navigator.storage) {
                        const estimate = await navigator.storage.estimate();
                        const used = estimate.usage || 0;
                        const quota = estimate.quota || 0;
                        
                        if (quota > 0) {
                            const usedMB = Math.round(used / 1024 / 1024);
                            const quotaMB = Math.round(quota / 1024 / 1024);
                            const percentUsed = Math.round((used / quota) * 100);
                            
                            console.log(`Storage: ${usedMB}MB used of ${quotaMB}MB (${percentUsed}%)`);
                            
                            if (percentUsed > 90) {
                                this.showNotification(`Storage almost full: ${usedMB}MB used of ${quotaMB}MB. Consider exporting profiles and clearing browser data.`, 'warning');
                            } else if (percentUsed > 75) {
                                this.showNotification(`Storage: ${usedMB}MB used of ${quotaMB}MB available`, 'info');
                            }
                        }
                    }
                } catch (error) {
                    console.warn('Could not check storage space:', error);
                }
            }

            log(message) {
                const timestamp = new Date().toISOString().substring(11, 19);
                const logElement = document.getElementById('status-log');
                logElement.innerHTML += `[${timestamp}] ${message}\n`;
                logElement.scrollTop = logElement.scrollHeight;
                console.log(`[ProfileSystem] ${message}`);
            }

            // Utility method to clear all profiles (for testing)
            clearAllProfiles() {
                if (confirm('Are you sure you want to delete ALL profiles? This cannot be undone.')) {
                    localStorage.removeItem(this.storageKey);
                    this.updateProfileDropdown();
                    this.updateProfilesDisplay();
                    this.updateProfileCount();
                    this.showNotification('All profiles cleared', 'success');
                    this.log('All profiles cleared');
                }
            }
        }

        // Initialize the profile system
        let profileSystem;
        document.addEventListener('DOMContentLoaded', function() {
            profileSystem = new LocalProfileSystem();
            
            // Make globally available for button onclick handlers
            window.profileSystem = profileSystem;
        });

        // Test data buttons for demo
        function fillSampleData(sampleType) {
            const samples = {
                e4_72v: {
                    'vehicle-model': 'e4',
                    'vehicle-year': '2010-2015',
                    'controller-type': 'T2',
                    'current-speed': '25',
                    'motor-type': 'dc-stock',
                    'battery-voltage': '72',
                    'battery-type': 'lead-acid',
                    'battery-capacity': '150',
                    'tire-diameter': '22',
                    'gear-ratio': '10.35:1',
                    'differential': 'standard',
                    'modifications': 'LED headlights, upgraded seat belts'
                },
                e6_96v: {
                    'vehicle-model': 'e6',
                    'vehicle-year': '2016-2019',
                    'controller-type': 'T2',
                    'current-speed': '30',
                    'motor-type': 'dc-upgrade',
                    'battery-voltage': '96',
                    'battery-type': 'lithium',
                    'battery-capacity': '200',
                    'tire-diameter': '23',
                    'gear-ratio': '8.91:1',
                    'differential': 'limited-slip',
                    'modifications': 'Performance motor, lithium conversion, custom wheels'
                }
            };

            const data = samples[sampleType];
            if (data) {
                Object.entries(data).forEach(([fieldId, value]) => {
                    const field = document.getElementById(fieldId);
                    if (field) {
                        field.value = value;
                    }
                });
                profileSystem.log(`Filled sample data: ${sampleType}`);
            }
        }

        // Add some demo buttons after the page loads
        document.addEventListener('DOMContentLoaded', function() {
            // Add demo buttons to the top of the form
            const vehicleForm = document.querySelector('.bg-white.rounded-lg.shadow-sm.border.border-gray-200:nth-child(3)');
            if (vehicleForm) {
                const demoDiv = document.createElement('div');
                demoDiv.className = 'mb-4 p-3 bg-blue-50 border border-blue-200 rounded-lg';
                demoDiv.innerHTML = `
                    <h4 class="font-medium text-blue-900 mb-2">Demo Data (for testing)</h4>
                    <div class="flex space-x-2">
                        <button onclick="fillSampleData('e4_72v')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                            Fill e4 72V Sample
                        </button>
                        <button onclick="fillSampleData('e6_96v')" class="px-3 py-1 bg-blue-600 text-white text-sm rounded hover:bg-blue-700">
                            Fill e6 96V Sample
                        </button>
                        <button onclick="profileSystem.clearAllProfiles()" class="px-3 py-1 bg-red-600 text-white text-sm rounded hover:bg-red-700">
                            Clear All Profiles
                        </button>
                    </div>
                `;
                vehicleForm.insertBefore(demoDiv, vehicleForm.firstChild.nextSibling);
            }
        });
    </script>
</body>
</html>