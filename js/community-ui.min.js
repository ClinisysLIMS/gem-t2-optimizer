class CommunityUI{constructor(){this.community=null,this.currentTab="browse",this.currentFilters={search:"",category:"",vehicleModel:"",sortBy:"recent"},this.configurations=[],this.loadedCount=0,this.batchSize=12,this.init()}async init(){void 0!==window.communityManager?(this.community=window.communityManager,console.log("Community UI initialized"),this.setupEventListeners(),this.loadInitialData(),window.addEventListener("authStateChanged",(e=>{this.handleAuthStateChange(e.detail.user)})),window.firebaseManager?.isAuthenticated()&&this.handleAuthStateChange(window.firebaseManager.getCurrentUser()),this.checkForShareIntent()):console.warn("Community manager not available")}setupEventListeners(){document.querySelectorAll(".tab-button").forEach((e=>{e.addEventListener("click",(e=>{this.switchTab(e.target.dataset.tab)}))})),document.getElementById("search-input")?.addEventListener("input",(e=>{this.debouncedSearch(e.target.value)})),document.getElementById("apply-filters")?.addEventListener("click",(()=>{this.applyFilters()})),document.getElementById("clear-filters")?.addEventListener("click",(()=>{this.clearFilters()})),document.getElementById("share-config-btn")?.addEventListener("click",(()=>{this.showShareModal()})),document.getElementById("guest-sign-in")?.addEventListener("click",(()=>{this.showSignInPrompt()})),document.getElementById("close-share-modal")?.addEventListener("click",(()=>{this.hideShareModal()})),document.getElementById("cancel-share")?.addEventListener("click",(()=>{this.hideShareModal()})),document.getElementById("share-form")?.addEventListener("submit",(e=>{e.preventDefault(),this.handleShareSubmit()})),document.getElementById("share-category")?.addEventListener("change",(e=>{this.updateShareFormSections(e.target.value)})),document.getElementById("load-current-vehicle")?.addEventListener("click",(()=>{this.loadCurrentVehicleData()})),document.getElementById("load-current-settings")?.addEventListener("click",(()=>{this.loadCurrentSettings()})),document.getElementById("my-configurations")?.addEventListener("click",(()=>{this.showMyConfigurations()})),document.getElementById("my-bookmarks")?.addEventListener("click",(()=>{this.showMyBookmarks()})),document.getElementById("my-downloads")?.addEventListener("click",(()=>{this.showMyDownloads()})),document.getElementById("load-more-btn")?.addEventListener("click",(()=>{this.loadMoreConfigurations()})),document.getElementById("share-modal")?.addEventListener("click",(e=>{"share-modal"===e.target.id&&this.hideShareModal()})),document.getElementById("detail-modal")?.addEventListener("click",(e=>{"detail-modal"===e.target.id&&this.hideDetailModal()}))}handleAuthStateChange(e){e?(this.showAuthenticatedUI(),this.loadUserStats()):this.showGuestUI()}async loadInitialData(){await Promise.all([this.loadConfigurations(),this.loadCommunityStats()])}async loadConfigurations(e=!0){e&&(this.configurations=[],this.loadedCount=0,this.showLoadingState());try{const t={...this.currentFilters,limit:this.batchSize};switch(this.currentTab){case"featured":t.featured=!0,t.sortBy="rating";break;case"recent":t.sortBy="recent";break;case"top-rated":t.sortBy="rating"}let n;n=this.currentFilters.search?await this.community.searchConfigurations(this.currentFilters.search,t):await this.community.getSharedConfigurations(t),e?this.configurations=n:this.configurations.push(...n),this.loadedCount=this.configurations.length,this.renderConfigurations()}catch(e){console.error("Error loading configurations:",e),this.showErrorState("Failed to load configurations")}}renderConfigurations(){const e=document.getElementById("config-cards"),t=document.getElementById("configurations-grid"),n=document.getElementById("empty-state");if(document.getElementById("loading-state").classList.add("hidden"),0===this.configurations.length)return t.classList.add("hidden"),void n.classList.remove("hidden");n.classList.add("hidden"),t.classList.remove("hidden"),e.innerHTML=this.configurations.map((e=>this.createConfigurationCard(e))).join(""),this.setupCardListeners();const o=document.getElementById("load-more-btn");this.configurations.length>=this.batchSize?o.classList.remove("hidden"):o.classList.add("hidden")}createConfigurationCard(e){const t=this.formatRating(e.averageRating),n=this.community.getUserRating(e.id),o=this.community.isBookmarked(e.id),a=this.community.canEdit(e),i=this.getCategoryBadge(e.category),s=this.getVehicleBadge(e.vehicleData.model);return`\n            <div class="config-card bg-white rounded-lg shadow-lg overflow-hidden" data-config-id="${e.id}">\n                \x3c!-- Card Header --\x3e\n                <div class="p-4 border-b border-gray-200">\n                    <div class="flex items-start justify-between mb-2">\n                        <h3 class="text-lg font-semibold text-gray-900 line-clamp-2 cursor-pointer hover:text-green-600" \n                            onclick="communityUI.showConfigurationDetail('${e.id}')">\n                            ${e.title}\n                        </h3>\n                        ${a?'<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">Mine</span>':""}\n                    </div>\n                    \n                    <div class="flex items-center space-x-2 mb-3">\n                        ${i}\n                        ${s}\n                        ${e.featured?'<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded">‚≠ê Featured</span>':""}\n                    </div>\n                    \n                    <p class="text-sm text-gray-600 line-clamp-3 mb-3">\n                        ${e.description}\n                    </p>\n                    \n                    \x3c!-- Tags --\x3e\n                    ${e.tags&&e.tags.length>0?`\n                        <div class="flex flex-wrap gap-1 mb-3">\n                            ${e.tags.slice(0,3).map((e=>`\n                                <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">#${e}</span>\n                            `)).join("")}\n                            ${e.tags.length>3?`<span class="text-xs text-gray-500">+${e.tags.length-3} more</span>`:""}\n                        </div>\n                    `:""}\n                    \n                    \x3c!-- Rating and Stats --\x3e\n                    <div class="flex items-center justify-between text-sm">\n                        <div class="flex items-center space-x-2">\n                            <div class="rating-stars">${t}</div>\n                            <span class="text-gray-600">(${e.ratingCount})</span>\n                        </div>\n                        <div class="flex items-center space-x-3 text-gray-600">\n                            <span title="Views">üëÅ ${e.viewCount}</span>\n                            <span title="Downloads">‚¨á ${e.downloadCount}</span>\n                            <span title="Comments">üí¨ ${e.commentCount}</span>\n                        </div>\n                    </div>\n                </div>\n                \n                \x3c!-- Card Footer --\x3e\n                <div class="p-4 bg-gray-50">\n                    <div class="flex items-center justify-between mb-3">\n                        <div class="text-sm text-gray-600">\n                            by <span class="font-medium">${e.authorName}</span>\n                        </div>\n                        <div class="text-xs text-gray-500">\n                            ${this.formatDate(e.createdAt)}\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Action Buttons --\x3e\n                    <div class="flex space-x-2">\n                        <button onclick="communityUI.showConfigurationDetail('${e.id}')" \n                                class="flex-1 bg-green-600 text-white px-3 py-2 rounded text-sm hover:bg-green-700">\n                            üëÅ View Details\n                        </button>\n                        \n                        <button onclick="communityUI.downloadConfiguration('${e.id}')" \n                                class="bg-blue-600 text-white px-3 py-2 rounded text-sm hover:bg-blue-700" \n                                title="Download & Apply">\n                            ‚¨á\n                        </button>\n                        \n                        <button onclick="communityUI.toggleBookmark('${e.id}')" \n                                class="px-3 py-2 rounded text-sm border ${o?"bg-yellow-100 border-yellow-300 text-yellow-700":"border-gray-300 text-gray-700 hover:bg-gray-50"}" \n                                title="${o?"Remove bookmark":"Bookmark"}">\n                            ${o?"üîñ":"üìñ"}\n                        </button>\n                        \n                        <div class="relative">\n                            <button onclick="communityUI.showRatingMenu('${e.id}')" \n                                    class="px-3 py-2 rounded text-sm border border-gray-300 text-gray-700 hover:bg-gray-50" \n                                    title="Rate this configuration">\n                                ${n>0?"‚òÖ":"‚òÜ"}\n                            </button>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- User Rating Display --\x3e\n                    ${n>0?`\n                        <div class="mt-2 text-xs text-gray-600 text-center">\n                            You rated: ${"‚òÖ".repeat(n)}${"‚òÜ".repeat(5-n)}\n                        </div>\n                    `:""}\n                </div>\n            </div>\n        `}async showConfigurationDetail(e){const t=await this.community.getConfiguration(e);if(!t)return void this.showError("Configuration not found");const n=await this.community.getComments(e),o=this.community.getUserRating(e),a=this.community.isBookmarked(e),i=this.community.canEdit(t);document.getElementById("detail-content").innerHTML=`\n            <div class="flex items-center justify-between p-6 border-b">\n                <div class="flex-1">\n                    <h2 class="text-2xl font-bold text-gray-900">${t.title}</h2>\n                    <div class="flex items-center space-x-3 mt-2">\n                        ${this.getCategoryBadge(t.category)}\n                        ${this.getVehicleBadge(t.vehicleData.model)}\n                        ${t.featured?'<span class="text-sm bg-yellow-100 text-yellow-800 px-3 py-1 rounded">‚≠ê Featured</span>':""}\n                    </div>\n                </div>\n                <button onclick="communityUI.hideDetailModal()" class="text-gray-400 hover:text-gray-600">\n                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>\n                    </svg>\n                </button>\n            </div>\n            \n            <div class="max-h-[70vh] overflow-y-auto">\n                <div class="p-6 space-y-6">\n                    \x3c!-- Description --\x3e\n                    <div>\n                        <h3 class="font-semibold mb-2">Description</h3>\n                        <p class="text-gray-700">${t.description}</p>\n                    </div>\n                    \n                    \x3c!-- Tags --\x3e\n                    ${t.tags&&t.tags.length>0?`\n                        <div>\n                            <h3 class="font-semibold mb-2">Tags</h3>\n                            <div class="flex flex-wrap gap-2">\n                                ${t.tags.map((e=>`\n                                    <span class="bg-gray-100 text-gray-700 px-3 py-1 rounded-full text-sm">#${e}</span>\n                                `)).join("")}\n                            </div>\n                        </div>\n                    `:""}\n                    \n                    \x3c!-- Route/Event Info --\x3e\n                    ${this.renderDetailSpecificInfo(t)}\n                    \n                    \x3c!-- Vehicle Information --\x3e\n                    <div>\n                        <h3 class="font-semibold mb-3">Vehicle Configuration</h3>\n                        <div class="bg-gray-50 rounded-lg p-4">\n                            <div class="grid md:grid-cols-2 gap-4 text-sm">\n                                <div><span class="text-gray-600">Model:</span> <span class="font-medium">${t.vehicleData.model}</span></div>\n                                <div><span class="text-gray-600">Year:</span> <span class="font-medium">${t.vehicleData.year}</span></div>\n                                <div><span class="text-gray-600">Controller:</span> <span class="font-medium">${t.vehicleData.controller}</span></div>\n                                <div><span class="text-gray-600">Motor:</span> <span class="font-medium">${t.vehicleData.motorType}</span></div>\n                                <div><span class="text-gray-600">Battery:</span> <span class="font-medium">${t.vehicleData.batteryVoltage}V ${t.vehicleData.batteryType}</span></div>\n                            </div>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Controller Settings --\x3e\n                    <div>\n                        <h3 class="font-semibold mb-3">Controller Settings</h3>\n                        <div class="bg-gray-50 rounded-lg p-4">\n                            ${this.renderControllerSettings(t.controllerSettings)}\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Stats and Ratings --\x3e\n                    <div class="grid md:grid-cols-2 gap-6">\n                        <div>\n                            <h3 class="font-semibold mb-3">Community Stats</h3>\n                            <div class="space-y-2 text-sm">\n                                <div class="flex justify-between">\n                                    <span class="text-gray-600">Rating:</span>\n                                    <span>${this.formatRating(t.averageRating)} (${t.ratingCount} votes)</span>\n                                </div>\n                                <div class="flex justify-between">\n                                    <span class="text-gray-600">Downloads:</span>\n                                    <span class="font-medium">${t.downloadCount}</span>\n                                </div>\n                                <div class="flex justify-between">\n                                    <span class="text-gray-600">Views:</span>\n                                    <span class="font-medium">${t.viewCount}</span>\n                                </div>\n                                <div class="flex justify-between">\n                                    <span class="text-gray-600">Bookmarks:</span>\n                                    <span class="font-medium">${t.bookmarkCount}</span>\n                                </div>\n                            </div>\n                        </div>\n                        \n                        <div>\n                            <h3 class="font-semibold mb-3">Author</h3>\n                            <div class="text-sm">\n                                <div class="font-medium">${t.authorName}</div>\n                                <div class="text-gray-600 mt-1">Shared ${this.formatDate(t.createdAt)}</div>\n                                ${t.verified?'<div class="text-green-600 mt-1">‚úì Verified contributor</div>':""}\n                            </div>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Rating Section --\x3e\n                    <div data-auth-required class="hidden">\n                        <h3 class="font-semibold mb-3">Rate This Configuration</h3>\n                        <div class="flex items-center space-x-4">\n                            <div class="rating-input" data-config-id="${e}">\n                                ${[1,2,3,4,5].map((t=>`\n                                    <button onclick="communityUI.rateConfiguration('${e}', ${t})" \n                                            class="rating-star text-2xl ${t<=o?"text-yellow-400":"text-gray-300"} hover:text-yellow-400">\n                                        ‚òÖ\n                                    </button>\n                                `)).join("")}\n                            </div>\n                            ${o>0?`<span class="text-sm text-gray-600">You rated: ${o}/5</span>`:""}\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Comments Section --\x3e\n                    <div>\n                        <h3 class="font-semibold mb-3">Comments (${n.length})</h3>\n                        \n                        \x3c!-- Add Comment (Auth Required) --\x3e\n                        <div data-auth-required class="hidden mb-4">\n                            <div class="flex space-x-3">\n                                <textarea id="new-comment" placeholder="Share your experience with this configuration..." \n                                          class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" \n                                          rows="2"></textarea>\n                                <button onclick="communityUI.addComment('${e}')" \n                                        class="bg-green-600 text-white px-4 py-2 rounded-md hover:bg-green-700">\n                                    Post\n                                </button>\n                            </div>\n                        </div>\n                        \n                        \x3c!-- Comments List --\x3e\n                        <div class="space-y-4" id="comments-list">\n                            ${n.length>0?n.map((e=>this.renderComment(e))).join(""):'<p class="text-gray-500 text-center py-4">No comments yet. Be the first to share your experience!</p>'}\n                        </div>\n                    </div>\n                </div>\n            </div>\n            \n            \x3c!-- Modal Footer --\x3e\n            <div class="border-t bg-gray-50 px-6 py-4">\n                <div class="flex space-x-3">\n                    <button onclick="communityUI.downloadConfiguration('${e}')" \n                            class="bg-green-600 text-white px-6 py-2 rounded-md hover:bg-green-700">\n                        ‚¨á Download & Apply\n                    </button>\n                    \n                    <button onclick="communityUI.toggleBookmark('${e}')" \n                            class="px-4 py-2 rounded-md border ${a?"bg-yellow-100 border-yellow-300 text-yellow-700":"border-gray-300 text-gray-700 hover:bg-gray-50"}">\n                        ${a?"üîñ Bookmarked":"üìñ Bookmark"}\n                    </button>\n                    \n                    ${i?`\n                        <button onclick="communityUI.editConfiguration('${e}')" \n                                class="px-4 py-2 border border-gray-300 text-gray-700 rounded-md hover:bg-gray-50">\n                            ‚úèÔ∏è Edit\n                        </button>\n                    `:""}\n                    \n                    <button onclick="communityUI.flagConfiguration('${e}')" \n                            class="ml-auto px-4 py-2 text-gray-500 hover:text-red-600 text-sm">\n                        üö© Report\n                    </button>\n                </div>\n            </div>\n        `,document.getElementById("detail-modal").classList.remove("hidden"),this.updateAuthRequiredElements()}async downloadConfiguration(e){try{const t=await this.community.downloadConfiguration(e);if(!t)return void this.showError("Failed to download configuration");void 0!==window.unifiedFlow?(this.applyConfigurationToForm(t),this.showSuccess(`Configuration "${t.title}" downloaded and applied!`),window.location.pathname.includes("index")||setTimeout((()=>{window.location.href="index-new.html"}),2e3)):(localStorage.setItem("pending-community-config",JSON.stringify(t)),this.showSuccess(`Configuration "${t.title}" downloaded! Go to the optimizer to apply it.`))}catch(e){console.error("Error downloading configuration:",e),this.showError("Failed to download configuration")}}applyConfigurationToForm(e){const t=e.vehicleData;Object.entries(t).forEach((([e,t])=>{const n=this.getFieldIdFromKey(e),o=document.getElementById(n);o&&t&&(o.value=t,o.dispatchEvent(new Event("change")))})),e.controllerSettings&&sessionStorage.setItem("community-settings",JSON.stringify(e.controllerSettings))}getFieldIdFromKey(e){return{model:"vehicle-model",year:"vehicle-year",controller:"controller-type",motorType:"motor-type",batteryVoltage:"battery-voltage",batteryType:"battery-type"}[e]||e}async rateConfiguration(e,t){try{const n=await this.community.rateConfiguration(e,t);if(n.success){this.showSuccess(`Rated ${t}/5 stars`);const n=document.querySelector(`[data-config-id="${e}"]`);n&&n.querySelectorAll(".rating-star").forEach(((e,n)=>{e.classList.toggle("text-yellow-400",n<t),e.classList.toggle("text-gray-300",n>=t)})),this.refreshConfiguration(e)}else this.showError(n.error)}catch(e){console.error("Error rating configuration:",e),this.showError("Failed to submit rating")}}async addComment(e){const t=document.getElementById("new-comment").value.trim();if(t)try{const n=await this.community.addComment(e,t);if(n.success){document.getElementById("new-comment").value="";const e=document.getElementById("comments-list"),t=this.renderComment(n.comment);e.innerHTML.includes("No comments yet")?e.innerHTML=t:e.insertAdjacentHTML("afterbegin",t),this.showSuccess("Comment added successfully")}else this.showError(n.error)}catch(e){console.error("Error adding comment:",e),this.showError("Failed to add comment")}else this.showError("Please enter a comment")}async toggleBookmark(e){try{const t=await this.community.toggleBookmark(e);if(void 0!==t.bookmarked){const n=t.bookmarked?"Added to bookmarks":"Removed from bookmarks";this.showSuccess(n),document.querySelectorAll(`[onclick*="toggleBookmark('${e}')"]`).forEach((e=>{t.bookmarked?(e.classList.add("bg-yellow-100","border-yellow-300","text-yellow-700"),e.classList.remove("border-gray-300","text-gray-700","hover:bg-gray-50"),e.innerHTML="üîñ",e.title="Remove bookmark"):(e.classList.remove("bg-yellow-100","border-yellow-300","text-yellow-700"),e.classList.add("border-gray-300","text-gray-700","hover:bg-gray-50"),e.innerHTML="üìñ",e.title="Bookmark")})),this.refreshConfiguration(e)}else this.showError(t.error)}catch(e){console.error("Error toggling bookmark:",e),this.showError("Please sign in to bookmark configurations")}}getCategoryBadge(e){return{route:'<span class="text-xs bg-blue-100 text-blue-800 px-2 py-1 rounded">üó∫ Route</span>',event:'<span class="text-xs bg-purple-100 text-purple-800 px-2 py-1 rounded">üéâ Event</span>',condition:'<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded">üå§ Condition</span>',general:'<span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded">‚öôÔ∏è General</span>'}[e]||""}getVehicleBadge(e){return`<span class="text-xs bg-indigo-100 text-indigo-800 px-2 py-1 rounded">üöó ${e?.toUpperCase()}</span>`}formatRating(e){return`${"‚òÖ".repeat(Math.floor(e))+"‚òÜ".repeat(5-Math.floor(e))} ${e.toFixed(1)}`}formatDate(e){if(!e)return"Unknown";return(e.toDate?e.toDate():new Date(e)).toLocaleDateString()}renderComment(e){return`\n            <div class="border border-gray-200 rounded-lg p-4">\n                <div class="flex items-start justify-between mb-2">\n                    <div class="font-medium text-sm">${e.authorName}</div>\n                    <div class="text-xs text-gray-500">${this.formatDate(e.createdAt)}</div>\n                </div>\n                <p class="text-sm text-gray-700">${e.text}</p>\n                ${e.likes>0?`<div class="mt-2 text-xs text-gray-500">üëç ${e.likes}</div>`:""}\n            </div>\n        `}renderControllerSettings(e){return e&&0!==Object.keys(e).length?`\n            <div class="grid md:grid-cols-2 gap-4">\n                ${Object.entries(e).map((([e,t])=>`\n                    <div class="flex justify-between">\n                        <span class="text-gray-600">F${e}:</span>\n                        <span class="font-medium">${t}</span>\n                    </div>\n                `)).join("")}\n            </div>\n        `:'<p class="text-gray-500">No specific settings shared</p>'}renderDetailSpecificInfo(e){let t="";return e.routeInfo&&(t+=`\n                <div>\n                    <h3 class="font-semibold mb-2">Route Information</h3>\n                    <div class="bg-gray-50 rounded-lg p-4 text-sm">\n                        ${e.routeInfo.start?`<div><span class="text-gray-600">Start:</span> ${e.routeInfo.start}</div>`:""}\n                        ${e.routeInfo.distance?`<div><span class="text-gray-600">Distance:</span> ${e.routeInfo.distance}</div>`:""}\n                    </div>\n                </div>\n            `),e.eventInfo&&(t+=`\n                <div>\n                    <h3 class="font-semibold mb-2">Event Information</h3>\n                    <div class="bg-gray-50 rounded-lg p-4 text-sm">\n                        ${e.eventInfo.name?`<div><span class="text-gray-600">Event:</span> ${e.eventInfo.name}</div>`:""}\n                        ${e.eventInfo.type?`<div><span class="text-gray-600">Type:</span> ${e.eventInfo.type}</div>`:""}\n                    </div>\n                </div>\n            `),e.conditions&&(t+=`\n                <div>\n                    <h3 class="font-semibold mb-2">Conditions</h3>\n                    <div class="bg-gray-50 rounded-lg p-4 text-sm">\n                        ${e.conditions.terrain?`<div><span class="text-gray-600">Terrain:</span> ${e.conditions.terrain}</div>`:""}\n                        ${e.conditions.surface?`<div><span class="text-gray-600">Surface:</span> ${e.conditions.surface}</div>`:""}\n                        ${e.conditions.weather?`<div><span class="text-gray-600">Weather:</span> ${e.conditions.weather}</div>`:""}\n                    </div>\n                </div>\n            `),t}showLoadingState(){document.getElementById("loading-state").classList.remove("hidden"),document.getElementById("configurations-grid").classList.add("hidden"),document.getElementById("empty-state").classList.add("hidden")}showAuthenticatedUI(){document.querySelectorAll("[data-auth-required]").forEach((e=>e.classList.remove("hidden"))),document.querySelectorAll("[data-guest-only]").forEach((e=>e.classList.add("hidden")))}showGuestUI(){document.querySelectorAll("[data-auth-required]").forEach((e=>e.classList.add("hidden"))),document.querySelectorAll("[data-guest-only]").forEach((e=>e.classList.remove("hidden")))}updateAuthRequiredElements(){window.firebaseManager?.isAuthenticated()?this.showAuthenticatedUI():this.showGuestUI()}showSuccess(e){this.showNotification(e,"success")}showError(e){this.showNotification(e,"error")}showNotification(e,t="info"){const n=document.createElement("div");n.className=`fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-md ${"success"===t?"bg-green-500":"error"===t?"bg-red-500":"bg-blue-500"} text-white`,n.textContent=e,document.body.appendChild(n),setTimeout((()=>{n.remove()}),4e3)}hideDetailModal(){document.getElementById("detail-modal").classList.add("hidden")}hideShareModal(){document.getElementById("share-modal").classList.add("hidden")}showShareModal(){window.firebaseManager?.isAuthenticated()?document.getElementById("share-modal").classList.remove("hidden"):this.showSignInPrompt()}showSignInPrompt(){window.firebaseProfileManager&&window.firebaseProfileManager.showAuthModal()}debouncedSearch(e){clearTimeout(this.searchTimeout),this.searchTimeout=setTimeout((()=>{this.currentFilters.search=e,this.loadConfigurations()}),500)}applyFilters(){this.currentFilters={search:document.getElementById("search-input").value,category:document.getElementById("category-filter").value,vehicleModel:document.getElementById("model-filter").value,sortBy:document.getElementById("sort-filter").value},this.loadConfigurations()}clearFilters(){document.getElementById("search-input").value="",document.getElementById("category-filter").value="",document.getElementById("model-filter").value="",document.getElementById("sort-filter").value="recent",this.currentFilters={search:"",category:"",vehicleModel:"",sortBy:"recent"},this.loadConfigurations()}switchTab(e){this.currentTab=e,document.querySelectorAll(".tab-button").forEach((e=>{e.classList.remove("active","border-green-500","text-green-600"),e.classList.add("border-transparent","text-gray-500")}));const t=document.querySelector(`[data-tab="${e}"]`);t.classList.add("active","border-green-500","text-green-600"),t.classList.remove("border-transparent","text-gray-500"),this.loadConfigurations()}async loadCommunityStats(){document.getElementById("total-configs").textContent="250+",document.getElementById("total-downloads").textContent="1,200+",document.getElementById("active-contributors").textContent="45",document.getElementById("featured-count").textContent="8"}async loadUserStats(){document.getElementById("my-configs-count").textContent="3 shared",document.getElementById("my-bookmarks-count").textContent="12 saved"}setupCardListeners(){}async refreshConfiguration(e){}async loadMoreConfigurations(){await this.loadConfigurations(!1)}checkForShareIntent(){if("true"===new URLSearchParams(window.location.search).get("share")){if(window.firebaseManager?.isAuthenticated()){const e=sessionStorage.getItem("pendingCommunityShare");e&&(this.preloadShareForm(JSON.parse(e)),this.showShareModal(),sessionStorage.removeItem("pendingCommunityShare"))}else this.showSignInPrompt();window.history.replaceState({},document.title,window.location.pathname)}}preloadShareForm(e){const t=e.optimizationMode||"balanced",n=`${(e.vehicleData.model||"GEM").toUpperCase()} ${t.charAt(0).toUpperCase()+t.slice(1)} Settings`;document.getElementById("share-title").value=n,"weekend"===e.tripData.preset?document.getElementById("share-category").value="route":"performance"===e.tripData.optimizationMode?document.getElementById("share-category").value="event":document.getElementById("share-category").value="general";const o=this.generateShareDescription(e);document.getElementById("share-description").value=o,this.shareData=e,this.updateVehicleSummary(e.vehicleData),this.updateSettingsSummary(e.controllerSettings),this.updateShareFormSections(document.getElementById("share-category").value)}generateShareDescription(e){const t=e.optimizationMode||"balanced";let n=`Optimized ${(e.vehicleData.model||"GEM").toUpperCase()} controller settings for ${t} performance. `;return n+="efficiency"===t?"These settings prioritize maximum range and energy efficiency for daily commuting and extended trips.":"performance"===t?"These settings maximize acceleration and top speed for events, rallies, or when you need extra power.":"These balanced settings provide a good compromise between performance and efficiency for general use.",n}updateVehicleSummary(e){const t=document.getElementById("vehicle-summary");e&&Object.keys(e).length>0?t.innerHTML=`\n                <div class="text-sm">\n                    <div><strong>Model:</strong> ${e.model||"Not specified"}</div>\n                    <div><strong>Year:</strong> ${e.year||"Not specified"}</div>\n                    <div><strong>Controller:</strong> ${e.controller||"Not specified"}</div>\n                    <div><strong>Motor:</strong> ${e.motorType||"Not specified"}</div>\n                    <div><strong>Battery:</strong> ${e.batteryVoltage||"?"}V ${e.batteryType||"Unknown"}</div>\n                </div>\n            `:t.textContent="No vehicle data loaded"}updateSettingsSummary(e){const t=document.getElementById("settings-summary");if(e&&Object.keys(e).length>0){const n=Object.keys(e).length;t.innerHTML=`\n                <div class="text-sm">\n                    <div><strong>Settings count:</strong> ${n} functions optimized</div>\n                    <div class="mt-1 text-xs text-gray-600">\n                        Functions: ${Object.keys(e).map((e=>`F${e}`)).join(", ")}\n                    </div>\n                </div>\n            `}else t.textContent="No settings loaded"}async handleShareSubmit(){const e=document.getElementById("share-title").value.trim(),t=document.getElementById("share-category").value,n=document.getElementById("share-description").value.trim(),o=document.getElementById("share-tags").value.split(",").map((e=>e.trim())).filter((e=>e));if(!e||!t||!n)return void this.showError("Please fill in all required fields");if(!this.shareData)return void this.showError("No configuration data to share");const a={title:e,description:n,category:t,tags:o,vehicleData:this.shareData.vehicleData,controllerSettings:this.shareData.controllerSettings,optimizationMode:this.shareData.optimizationMode,routeInfo:this.gatherRouteInfo(),eventInfo:this.gatherEventInfo(),conditions:this.gatherConditionInfo()};try{const t=await this.community.shareConfiguration(a);t.success?(this.showSuccess(`Configuration "${e}" shared successfully!`),this.hideShareModal(),this.clearShareForm(),this.loadConfigurations()):this.showError(t.error)}catch(e){console.error("Error sharing configuration:",e),this.showError("Failed to share configuration")}}gatherRouteInfo(){return"route"!==document.getElementById("share-category").value?null:{start:document.getElementById("route-start")?.value||"",distance:document.getElementById("route-distance")?.value||""}}gatherEventInfo(){return"event"!==document.getElementById("share-category").value?null:{name:document.getElementById("event-name")?.value||"",type:document.getElementById("event-type")?.value||""}}gatherConditionInfo(){return"condition"!==document.getElementById("share-category").value?null:{terrain:document.getElementById("condition-terrain")?.value||"",surface:document.getElementById("condition-surface")?.value||"",weather:document.getElementById("condition-weather")?.value||""}}updateShareFormSections(e){document.getElementById("route-info").classList.add("hidden"),document.getElementById("event-info").classList.add("hidden"),document.getElementById("condition-info").classList.add("hidden"),"route"===e?document.getElementById("route-info").classList.remove("hidden"):"event"===e?document.getElementById("event-info").classList.remove("hidden"):"condition"===e&&document.getElementById("condition-info").classList.remove("hidden")}loadCurrentVehicleData(){if(void 0!==window.unifiedFlow){const e=window.unifiedFlow.vehicleData;this.shareData=this.shareData||{},this.shareData.vehicleData=e,this.updateVehicleSummary(e)}else this.showError("No vehicle data available. Please complete the optimizer first.")}loadCurrentSettings(){if(void 0!==window.unifiedFlow&&window.unifiedFlow.lastOptimizedSettings){const e=window.unifiedFlow.lastOptimizedSettings;this.shareData=this.shareData||{},this.shareData.controllerSettings=e,this.updateSettingsSummary(e)}else this.showError("No optimization results available. Please run the optimizer first.")}clearShareForm(){document.getElementById("share-form").reset(),this.shareData=null,this.updateVehicleSummary(null),this.updateSettingsSummary(null),this.updateShareFormSections("")}}document.addEventListener("DOMContentLoaded",(()=>{window.communityUI=new CommunityUI})),"undefined"!=typeof module&&module.exports&&(module.exports=CommunityUI);