class LocalProfileManager{constructor(){this.auth=null,this.storage=null,this.currentProfile=null,this.profiles=[],this.init()}async init(){this.waitForServices().then((()=>{this.auth=window.localAuth,this.storage=window.localStorageService,console.log("Local Profile Manager initialized"),this.auth.onAuthStateChanged((e=>{this.handleAuthStateChange(e)})),this.auth.isAuthenticated()&&this.loadUserProfiles()})).catch((e=>{console.warn("Failed to initialize profile manager:",e)})),this.setupProfileUI(),this.setupEventListeners()}async waitForServices(){return new Promise(((e,t)=>{const n=()=>{window.localAuth&&window.localStorageService?e():setTimeout(n,100)};n(),setTimeout((()=>t(new Error("Services timeout"))),1e4)}))}async handleAuthStateChange(e){e?(await this.loadUserProfiles(),this.showProfileOptions(),this.updateUserDisplay(e)):(this.clearProfiles(),this.hideProfileOptions())}async loadUserProfiles(){if(this.auth.isAuthenticated())try{const e=this.auth.getCurrentUser();this.profiles=await this.storage.getProfiles(e.uid)||[],this.profiles.sort(((e,t)=>new Date(t.lastUsed)-new Date(e.lastUsed))),console.log(`Loaded ${this.profiles.length} profiles`),this.updateProfileUI()}catch(e){console.error("Error loading profiles:",e)}}async saveCurrentProfile(e,t=""){if(!this.auth.isAuthenticated())return this.showError("Profile save failed - local storage not available"),!1;try{const n=this.gatherCurrentVehicleData(),i=this.gatherCurrentTripSettings(),r=this.gatherCurrentControllerSettings();if(!n.model)return this.showError("Please complete vehicle information before saving profile"),!1;const o=this.auth.getCurrentUser(),s={id:this.generateProfileId(),name:e,description:t,vehicleData:n,tripSettings:i,controllerSettings:r,createdAt:(new Date).toISOString(),lastUsed:(new Date).toISOString(),version:"1.0",userId:o.uid};if(await this.storage.saveProfile(o.uid,s))return this.profiles.unshift(s),this.updateProfileUI(),this.showSuccess(`Profile "${e}" saved successfully!`),!0;throw new Error("Failed to save profile to storage")}catch(e){return console.error("Error saving profile:",e),this.showError("Profile save failed - please check your browser storage"),!1}}async loadProfile(e){const t=this.profiles.find((t=>t.id===e));if(!t)return this.showError("Profile not found in local storage"),!1;try{return this.applyVehicleData(t.vehicleData),t.tripSettings&&this.applyTripSettings(t.tripSettings),this.currentProfile=t,await this.updateProfileLastUsed(e),this.showSuccess(`Profile "${t.name}" loaded!`),"undefined"!=typeof unifiedFlow&&unifiedFlow.validateStep1(),!0}catch(e){return console.error("Error loading profile:",e),this.showError("Profile load failed - please check your browser storage"),!1}}async updateProfileLastUsed(e){if(this.auth.isAuthenticated())try{const t=this.auth.getCurrentUser(),n=this.profiles.find((t=>t.id===e));n&&(n.lastUsed=(new Date).toISOString(),await this.storage.saveProfile(t.uid,n))}catch(e){console.warn("Failed to update last used timestamp:",e)}}async deleteProfile(e){if(!this.auth.isAuthenticated())return!1;try{const t=this.auth.getCurrentUser();if(await this.storage.deleteProfile(t.uid,e))return this.profiles=this.profiles.filter((t=>t.id!==e)),this.updateProfileUI(),this.showSuccess("Profile deleted"),!0;throw new Error("Failed to delete profile from storage")}catch(e){return console.error("Error deleting profile:",e),this.showError("Profile deletion failed - please check your browser storage"),!1}}async saveTripHistory(e){if(!this.auth.isAuthenticated())return!1;try{const t=this.auth.getCurrentUser(),n={id:this.generateTripId(),...e,profileId:this.currentProfile?.id||null,timestamp:(new Date).toISOString(),userId:t.uid};return await this.storage.saveTripHistory(t.uid,n)}catch(e){return console.error("Error saving trip history:",e),!1}}async getTripHistory(e=10){if(!this.auth.isAuthenticated())return[];try{const t=this.auth.getCurrentUser();return await this.storage.getTripHistory(t.uid,e)||[]}catch(e){return console.error("Error loading trip history:",e),[]}}async autoSave(){if(!this.auth.isAuthenticated())return!1;try{const e=this.auth.getCurrentUser(),t=this.gatherCurrentVehicleData(),n={vehicleData:t,tripSettings:this.gatherCurrentTripSettings(),timestamp:(new Date).toISOString()};return await this.storage.saveAutoSave(e.uid,n)}catch(e){return console.error("Error auto-saving:",e),!1}}async loadAutoSave(){if(!this.auth.isAuthenticated())return null;try{const e=this.auth.getCurrentUser();return await this.storage.getAutoSave(e.uid)}catch(e){return console.error("Error loading auto-save:",e),null}}gatherCurrentVehicleData(){return{model:document.getElementById("vehicle-model")?.value||"",year:document.getElementById("vehicle-year")?.value||"",controller:document.getElementById("controller-type")?.value||"",motorType:document.getElementById("motor-type")?.value||"",motorModel:document.getElementById("motor-model")?.value||"",motorPower:document.getElementById("motor-power")?.value||"",currentSpeed:document.getElementById("current-speed")?.value||"",batteryVoltage:document.getElementById("battery-voltage")?.value||"",batteryType:document.getElementById("battery-type")?.value||"",batteryCapacity:document.getElementById("battery-capacity")?.value||"",tireDiameter:document.getElementById("tire-diameter")?.value||"",gearRatio:document.getElementById("gear-ratio")?.value||"",motorAge:document.getElementById("motor-age")?.value||"",motorLastService:document.getElementById("motor-last-service")?.value||"",motorCondition:this.gatherMotorCondition()}}gatherMotorCondition(){return{sparking:document.getElementById("motor-sparking")?.checked||!1,noise:document.getElementById("motor-noise")?.checked||!1,overheating:document.getElementById("motor-overheating")?.checked||!1,vibration:document.getElementById("motor-vibration")?.checked||!1,powerLoss:document.getElementById("motor-power-loss")?.checked||!1}}gatherCurrentTripSettings(){const e={},t=document.querySelector(".quick-action-btn.selected");return t&&(e.quickAction=t.dataset.action),"undefined"!=typeof tripPlanner&&(e.tripData=tripPlanner.getCurrentTripData()),e}gatherCurrentControllerSettings(){const e={};return"undefined"!=typeof optimizer&&optimizer.lastGeneratedSettings&&(e.optimized=optimizer.lastGeneratedSettings),window.importedSettings&&(e.imported=window.importedSettings),e}applyVehicleData(e){const t={"vehicle-model":e.model,"vehicle-year":e.year,"controller-type":e.controller,"motor-type":e.motorType,"motor-model":e.motorModel,"motor-power":e.motorPower,"current-speed":e.currentSpeed,"battery-voltage":e.batteryVoltage,"battery-type":e.batteryType,"battery-capacity":e.batteryCapacity,"tire-diameter":e.tireDiameter,"gear-ratio":e.gearRatio,"motor-age":e.motorAge,"motor-last-service":e.motorLastService};if(Object.entries(t).forEach((([e,t])=>{const n=document.getElementById(e);n&&t&&(n.value=t,n.dispatchEvent(new Event("change")))})),e.motorCondition){const t={"motor-sparking":e.motorCondition.sparking,"motor-noise":e.motorCondition.noise,"motor-overheating":e.motorCondition.overheating,"motor-vibration":e.motorCondition.vibration,"motor-power-loss":e.motorCondition.powerLoss};Object.entries(t).forEach((([e,t])=>{const n=document.getElementById(e);n&&(n.checked=t)}))}}applyTripSettings(e){if(e.quickAction){const t=document.querySelector(`[data-action="${e.quickAction}"]`);t&&t.classList.add("selected")}}setupProfileUI(){this.createProfileManagementUI()}createProfileManagementUI(){const e=document.getElementById("vehicle-info-section");if(!e)return;const t=document.createElement("div");t.id="profile-management-section",t.className="mt-6 pt-6 border-t",t.innerHTML='\n            <div class="flex items-center justify-between mb-4">\n                <h3 class="font-semibold text-gray-800">Vehicle Profiles</h3>\n                <div id="profile-auth-status" class="text-sm text-gray-600">\n                    <span data-guest-only>Sign in to save profiles</span>\n                    <span data-auth-required class="hidden">\n                        <span data-user-info="displayName"></span> â€¢ \n                        <button id="sign-out-btn" class="text-red-600 hover:text-red-500">Sign Out</button>\n                    </span>\n                </div>\n            </div>\n            \n            \x3c!-- Guest UI --\x3e\n            <div data-guest-only class="bg-blue-50 border border-blue-200 rounded-lg p-4">\n                <div class="flex items-start">\n                    <div class="flex-shrink-0">\n                        <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">\n                            <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>\n                        </svg>\n                    </div>\n                    <div class="ml-3">\n                        <h4 class="text-sm font-medium text-blue-900">Save Your Vehicle Configurations</h4>\n                        <p class="text-sm text-blue-700 mt-1">\n                            Create an account to save multiple GEM profiles locally on this device.\n                        </p>\n                        <div class="mt-3 space-x-2">\n                            <button id="show-auth-modal" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">\n                                Sign In / Sign Up\n                            </button>\n                        </div>\n                    </div>\n                </div>\n            </div>\n            \n            \x3c!-- Authenticated UI --\x3e\n            <div data-auth-required class="hidden">\n                \x3c!-- Profile Actions --\x3e\n                <div class="mb-4 flex space-x-2">\n                    <button id="save-profile-btn" class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700 disabled:opacity-50">\n                        ðŸ’¾ Save Current Profile\n                    </button>\n                    <button id="load-profile-btn" class="bg-blue-600 text-white px-4 py-2 rounded text-sm hover:bg-blue-700">\n                        ðŸ“‚ Load Profile\n                    </button>\n                    <button id="auto-save-btn" class="bg-purple-600 text-white px-4 py-2 rounded text-sm hover:bg-purple-700">\n                        ðŸ”„ Auto Save\n                    </button>\n                </div>\n                \n                \x3c!-- Current Profile Display --\x3e\n                <div id="current-profile-display" class="hidden mb-4 p-3 bg-green-50 border border-green-200 rounded-lg">\n                    <div class="flex items-center justify-between">\n                        <div>\n                            <span class="text-sm font-medium text-green-800">Current Profile:</span>\n                            <span id="current-profile-name" class="text-sm text-green-700 ml-2"></span>\n                        </div>\n                        <button id="clear-profile-btn" class="text-xs text-green-600 hover:text-green-500">Clear</button>\n                    </div>\n                </div>\n                \n                \x3c!-- Quick Profile List --\x3e\n                <div id="quick-profiles" class="grid md:grid-cols-2 gap-3"></div>\n            </div>\n        ',e.appendChild(t),this.createAuthModal(),this.createProfileModal()}createAuthModal(){const e=document.createElement("div");e.id="auth-modal",e.className="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center",e.innerHTML='\n            <div class="bg-white rounded-lg p-6 max-w-md w-full mx-4">\n                <div class="flex items-center justify-between mb-4">\n                    <h3 class="text-lg font-semibold">Local Account</h3>\n                    <button id="close-auth-modal" class="text-gray-400 hover:text-gray-600">\n                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>\n                        </svg>\n                    </button>\n                </div>\n                \n                <div class="mb-4 p-3 bg-yellow-50 border border-yellow-200 rounded text-sm text-yellow-800">\n                    <strong>Note:</strong> This creates a local account stored on your device only. \n                    Your profiles won\'t sync between devices.\n                </div>\n                \n                <div id="auth-form">\n                    \x3c!-- Sign In Form --\x3e\n                    <div id="signin-form">\n                        <div class="space-y-4">\n                            <div>\n                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>\n                                <input type="email" id="signin-email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>\n                            </div>\n                            <div>\n                                <label class="block text-sm font-medium text-gray-700 mb-1">Password</label>\n                                <input type="password" id="signin-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>\n                            </div>\n                            <button id="signin-btn" class="w-full bg-blue-600 text-white py-2 rounded-md hover:bg-blue-700">\n                                Sign In\n                            </button>\n                        </div>\n                        \n                        <div class="mt-4 text-center">\n                            <button id="show-signup" class="text-sm text-blue-600 hover:text-blue-500">\n                                Don\'t have an account? Sign up\n                            </button>\n                        </div>\n                    </div>\n                    \n                    \x3c!-- Sign Up Form --\x3e\n                    <div id="signup-form" class="hidden">\n                        <div class="space-y-4">\n                            <div>\n                                <label class="block text-sm font-medium text-gray-700 mb-1">Full Name</label>\n                                <input type="text" id="signup-name" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>\n                            </div>\n                            <div>\n                                <label class="block text-sm font-medium text-gray-700 mb-1">Email</label>\n                                <input type="email" id="signup-email" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>\n                            </div>\n                            <div>\n                                <label class="block text-sm font-medium text-gray-700 mb-1">Password (min 6 characters)</label>\n                                <input type="password" id="signup-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500" required>\n                            </div>\n                            <button id="signup-btn" class="w-full bg-green-600 text-white py-2 rounded-md hover:bg-green-700">\n                                Create Account\n                            </button>\n                        </div>\n                        \n                        <div class="mt-4 text-center">\n                            <button id="show-signin" class="text-sm text-blue-600 hover:text-blue-500">\n                                Already have an account? Sign in\n                            </button>\n                        </div>\n                    </div>\n                </div>\n                \n                <div id="auth-error" class="hidden mt-4 p-3 bg-red-50 border border-red-200 rounded text-sm text-red-700"></div>\n            </div>\n        ',document.body.appendChild(e)}createProfileModal(){const e=document.createElement("div");e.id="profile-modal",e.className="fixed inset-0 bg-black bg-opacity-50 z-50 hidden flex items-center justify-center",e.innerHTML='\n            <div class="bg-white rounded-lg p-6 max-w-2xl w-full mx-4 max-h-[80vh] overflow-y-auto">\n                <div class="flex items-center justify-between mb-4">\n                    <h3 class="text-lg font-semibold">Manage Vehicle Profiles</h3>\n                    <button id="close-profile-modal" class="text-gray-400 hover:text-gray-600">\n                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">\n                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>\n                        </svg>\n                    </button>\n                </div>\n                \n                \x3c!-- Save New Profile --\x3e\n                <div id="save-profile-section" class="mb-6 p-4 bg-gray-50 rounded-lg">\n                    <h4 class="font-medium text-gray-800 mb-3">Save Current Configuration</h4>\n                    <div class="space-y-3">\n                        <div>\n                            <label class="block text-sm font-medium text-gray-700 mb-1">Profile Name *</label>\n                            <input type="text" id="new-profile-name" placeholder="e.g., My Daily Commuter" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" required>\n                        </div>\n                        <div>\n                            <label class="block text-sm font-medium text-gray-700 mb-1">Description</label>\n                            <textarea id="new-profile-description" placeholder="Optional description of this configuration" rows="2" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500"></textarea>\n                        </div>\n                        <button id="save-new-profile-btn" class="bg-green-600 text-white px-4 py-2 rounded text-sm hover:bg-green-700">\n                            ðŸ’¾ Save Profile\n                        </button>\n                    </div>\n                </div>\n                \n                \x3c!-- Existing Profiles --\x3e\n                <div>\n                    <h4 class="font-medium text-gray-800 mb-3">Your Saved Profiles</h4>\n                    <div id="profiles-list" class="space-y-3">\n                        \x3c!-- Profiles will be populated here --\x3e\n                    </div>\n                </div>\n            </div>\n        ',document.body.appendChild(e)}setupEventListeners(){document.getElementById("show-auth-modal")?.addEventListener("click",(()=>this.showAuthModal())),document.getElementById("close-auth-modal")?.addEventListener("click",(()=>this.hideAuthModal())),document.getElementById("show-signup")?.addEventListener("click",(()=>this.showSignUpForm())),document.getElementById("show-signin")?.addEventListener("click",(()=>this.showSignInForm())),document.getElementById("signin-btn")?.addEventListener("click",(()=>this.handleSignIn())),document.getElementById("signup-btn")?.addEventListener("click",(()=>this.handleSignUp())),document.getElementById("sign-out-btn")?.addEventListener("click",(()=>this.handleSignOut())),document.getElementById("save-profile-btn")?.addEventListener("click",(()=>this.showProfileModal())),document.getElementById("load-profile-btn")?.addEventListener("click",(()=>this.showProfileModal())),document.getElementById("close-profile-modal")?.addEventListener("click",(()=>this.hideProfileModal())),document.getElementById("save-new-profile-btn")?.addEventListener("click",(()=>this.handleSaveNewProfile())),document.getElementById("clear-profile-btn")?.addEventListener("click",(()=>this.clearCurrentProfile())),document.getElementById("auto-save-btn")?.addEventListener("click",(()=>this.handleAutoSave())),document.getElementById("auth-modal")?.addEventListener("click",(e=>{"auth-modal"===e.target.id&&this.hideAuthModal()})),document.getElementById("profile-modal")?.addEventListener("click",(e=>{"profile-modal"===e.target.id&&this.hideProfileModal()})),document.getElementById("signin-password")?.addEventListener("keypress",(e=>{"Enter"===e.key&&this.handleSignIn()})),document.getElementById("signup-password")?.addEventListener("keypress",(e=>{"Enter"===e.key&&this.handleSignUp()}))}async handleSignIn(){const e=document.getElementById("signin-email").value,t=document.getElementById("signin-password").value;if(e&&t)try{await this.auth.signInWithEmailAndPassword(e,t),this.hideAuthModal()}catch(e){this.showAuthError(e.message)}else this.showAuthError("Please enter both email and password")}async handleSignUp(){const e=document.getElementById("signup-name").value,t=document.getElementById("signup-email").value,n=document.getElementById("signup-password").value;if(e&&t&&n)try{(await this.auth.createUserWithEmailAndPassword(t,n)).user&&await this.auth.updateProfile({displayName:e}),this.hideAuthModal()}catch(e){this.showAuthError(e.message)}else this.showAuthError("Please fill in all fields")}async handleSignOut(){await this.auth.signOut()}async handleAutoSave(){await this.autoSave()?this.showSuccess("Configuration auto-saved successfully"):this.showError("Failed to auto-save configuration")}async handleSaveNewProfile(){const e=document.getElementById("new-profile-name").value.trim(),t=document.getElementById("new-profile-description").value.trim();if(!e)return void this.showError("Please enter a profile name");await this.saveCurrentProfile(e,t)&&(document.getElementById("new-profile-name").value="",document.getElementById("new-profile-description").value="",this.hideProfileModal())}clearCurrentProfile(){this.currentProfile=null,this.updateCurrentProfileDisplay()}updateProfileUI(){this.updateQuickProfiles(),this.updateProfilesList(),this.updateCurrentProfileDisplay()}updateQuickProfiles(){const e=document.getElementById("quick-profiles");e&&(e.innerHTML="",0!==this.profiles.length?this.profiles.slice(0,4).forEach((t=>{const n=document.createElement("div");n.className="border border-gray-200 rounded-lg p-3 hover:border-green-400 cursor-pointer transition-colors",n.innerHTML=`\n                <div class="flex items-center justify-between mb-2">\n                    <h4 class="font-medium text-sm text-gray-800">${t.name}</h4>\n                    <span class="text-xs text-gray-500">${this.formatDate(t.lastUsed)}</span>\n                </div>\n                <div class="text-xs text-gray-600">\n                    ${t.vehicleData.model||"Unknown model"} â€¢ ${t.vehicleData.year||"Unknown year"}\n                </div>\n                <div class="mt-2 flex space-x-2">\n                    <button class="load-profile-btn text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded hover:bg-blue-200" data-profile-id="${t.id}">\n                        Load\n                    </button>\n                    <button class="delete-profile-btn text-xs bg-red-100 text-red-700 px-2 py-1 rounded hover:bg-red-200" data-profile-id="${t.id}">\n                        Delete\n                    </button>\n                </div>\n            `,n.querySelector(".load-profile-btn").addEventListener("click",(e=>{e.stopPropagation(),this.loadProfile(t.id)})),n.querySelector(".delete-profile-btn").addEventListener("click",(e=>{e.stopPropagation(),confirm(`Delete profile "${t.name}"?`)&&this.deleteProfile(t.id)})),e.appendChild(n)})):e.innerHTML='<p class="text-sm text-gray-500 col-span-2">No saved profiles yet</p>')}updateProfilesList(){const e=document.getElementById("profiles-list");e&&(e.innerHTML="",0!==this.profiles.length?this.profiles.forEach((t=>{const n=document.createElement("div");n.className="border border-gray-200 rounded-lg p-4",n.innerHTML=`\n                <div class="flex items-start justify-between">\n                    <div class="flex-1">\n                        <h5 class="font-medium text-gray-800">${t.name}</h5>\n                        <p class="text-sm text-gray-600 mt-1">${t.description||"No description"}</p>\n                        <div class="text-xs text-gray-500 mt-2">\n                            ${t.vehicleData.model||"Unknown model"} â€¢ ${t.vehicleData.year||"Unknown year"} â€¢ \n                            Last used: ${this.formatDate(t.lastUsed)}\n                        </div>\n                    </div>\n                    <div class="flex space-x-2 ml-4">\n                        <button class="load-profile-btn text-sm bg-blue-600 text-white px-3 py-1 rounded hover:bg-blue-700" data-profile-id="${t.id}">\n                            Load\n                        </button>\n                        <button class="delete-profile-btn text-sm bg-red-600 text-white px-3 py-1 rounded hover:bg-red-700" data-profile-id="${t.id}">\n                            Delete\n                        </button>\n                    </div>\n                </div>\n            `,n.querySelector(".load-profile-btn").addEventListener("click",(()=>{this.loadProfile(t.id),this.hideProfileModal()})),n.querySelector(".delete-profile-btn").addEventListener("click",(()=>{confirm(`Delete profile "${t.name}"?`)&&this.deleteProfile(t.id)})),e.appendChild(n)})):e.innerHTML='<p class="text-sm text-gray-500">No saved profiles yet</p>')}updateCurrentProfileDisplay(){const e=document.getElementById("current-profile-display"),t=document.getElementById("current-profile-name");e&&t&&(this.currentProfile?(t.textContent=this.currentProfile.name,e.classList.remove("hidden")):e.classList.add("hidden"))}updateUserDisplay(e){document.querySelectorAll('[data-user-info="displayName"]').forEach((t=>{t.textContent=e.displayName||e.email.split("@")[0]}))}showAuthModal(){document.getElementById("auth-modal").classList.remove("hidden")}hideAuthModal(){document.getElementById("auth-modal").classList.add("hidden"),this.clearAuthError()}showProfileModal(){document.getElementById("profile-modal").classList.remove("hidden")}hideProfileModal(){document.getElementById("profile-modal").classList.add("hidden")}showSignUpForm(){document.getElementById("signin-form").classList.add("hidden"),document.getElementById("signup-form").classList.remove("hidden"),this.clearAuthError()}showSignInForm(){document.getElementById("signup-form").classList.add("hidden"),document.getElementById("signin-form").classList.remove("hidden"),this.clearAuthError()}showAuthError(e){const t=document.getElementById("auth-error");t.textContent=e,t.classList.remove("hidden")}clearAuthError(){document.getElementById("auth-error").classList.add("hidden")}showProfileOptions(){document.querySelectorAll("[data-auth-required]").forEach((e=>e.classList.remove("hidden"))),document.querySelectorAll("[data-guest-only]").forEach((e=>e.classList.add("hidden")))}hideProfileOptions(){document.querySelectorAll("[data-auth-required]").forEach((e=>e.classList.add("hidden"))),document.querySelectorAll("[data-guest-only]").forEach((e=>e.classList.remove("hidden")))}clearProfiles(){this.profiles=[],this.currentProfile=null,this.updateProfileUI()}generateProfileId(){return"profile_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}generateTripId(){return"trip_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}formatDate(e){if(!e)return"Unknown";const t=new Date(e),n=new Date-t,i=Math.floor(n/864e5);return 0===i?"Today":1===i?"Yesterday":i<7?`${i} days ago`:t.toLocaleDateString()}showSuccess(e){this.showNotification(e,"success")}showError(e){(e.includes("storage")||e.includes("save")||e.includes("failed"))&&this.checkStorageSpace(),this.showNotification(e,"error")}async checkStorageSpace(){try{if("storage"in navigator&&"estimate"in navigator.storage){const e=await navigator.storage.estimate(),t=e.usage||0,n=e.quota||0;if(n>0){const e=Math.round(t/1024/1024),i=Math.round(n/1024/1024),r=Math.round(t/n*100);console.log(`Storage: ${e}MB used of ${i}MB (${r}%)`),r>90?this.showNotification(`Storage almost full: ${e}MB used of ${i}MB. Consider exporting profiles and clearing browser data.`,"warning"):r>75&&this.showNotification(`Storage: ${e}MB used of ${i}MB available`,"info")}}}catch(e){console.warn("Could not check storage space:",e)}}showNotification(e,t="info"){const n=document.createElement("div");n.className=`fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 max-w-md ${"success"===t?"bg-green-500":"error"===t?"bg-red-500":"bg-blue-500"} text-white`,n.textContent=e,document.body.appendChild(n),setTimeout((()=>{n.remove()}),4e3)}}document.addEventListener("DOMContentLoaded",(()=>{window.localProfileManager=new LocalProfileManager})),"undefined"!=typeof module&&module.exports&&(module.exports=LocalProfileManager);