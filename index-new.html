<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEM T2 Optimizer - Smart Weekend Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-green-700 text-white py-2 px-4 no-print border-b border-green-600">
        <div class="container mx-auto">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-lg font-bold">üöó‚ö° GEM T2 Smart Optimizer</h1>
                    <p class="text-xs opacity-90">AI-Powered Weekend Planning & Controller Optimization</p>
                </div>
                <nav class="hidden md:flex space-x-2">
                    <a href="user-guide.html" class="text-xs hover:underline px-2 py-1 rounded hover:bg-green-600 transition-colors">üìö User Guide</a>
                    <a href="community.html" class="text-xs hover:underline px-2 py-1 rounded hover:bg-green-600 transition-colors">üåü Community</a>
                    <a href="weekend-planner.html" class="text-xs hover:underline px-2 py-1 rounded hover:bg-green-600 transition-colors">Weekend Planner</a>
                    <a href="reference-guide.html" class="text-xs hover:underline px-2 py-1 rounded hover:bg-green-600 transition-colors">Reference Guide</a>
                    <a href="accessories-config.html" class="text-xs hover:underline px-2 py-1 rounded hover:bg-green-600 transition-colors">Accessories</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-2">
        <!-- AI-Powered Optimization Banner -->
        <div class="max-w-4xl mx-auto mb-3 border-b border-gray-200 pb-2">
            <div class="bg-gradient-to-r from-green-500 to-blue-500 rounded-md p-2 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="text-sm mr-2">ü§ñ</span>
                        <div>
                            <h2 class="font-medium text-sm">AI-Powered Optimization</h2>
                            <p class="text-xs opacity-90">Smart controller settings with local AI and rule-based analysis</p>
                        </div>
                    </div>
                    <button onclick="document.getElementById('settings-section').classList.remove('hidden'); document.getElementById('settings-section').scrollIntoView({behavior: 'smooth'})" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-2 py-1 rounded text-xs transition-colors">
                        Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Flow Container -->
        <div id="main-flow" class="max-w-4xl mx-auto">
            
            <!-- Welcome Section -->
            <section id="welcome-section" class="bg-white rounded-md shadow-sm border border-gray-200 p-3 mb-3">
                <div class="text-center mb-3">
                    <h2 class="text-lg font-bold text-gray-900 mb-1">Welcome to the Future of GEM Optimization</h2>
                    <p class="text-sm text-gray-600">AI-powered controller optimization in 3 simple steps</p>
                </div>
                
                <div class="grid md:grid-cols-3 gap-2">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-2 rounded-md border border-blue-200">
                        <div class="text-blue-600 text-lg mb-1">1Ô∏è‚É£</div>
                        <h3 class="font-medium text-blue-900 mb-1 text-sm">Vehicle Info</h3>
                        <p class="text-xs text-blue-700">Enter your GEM details for personalized optimization</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-2 rounded-md border border-green-200">
                        <div class="text-green-600 text-lg mb-1">2Ô∏è‚É£</div>
                        <h3 class="font-medium text-green-900 mb-1 text-sm">Trip Planning</h3>
                        <p class="text-xs text-green-700">Choose your usage pattern or plan a weekend trip</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-2 rounded-md border border-purple-200">
                        <div class="text-purple-600 text-lg mb-1">3Ô∏è‚É£</div>
                        <h3 class="font-medium text-purple-900 mb-1 text-sm">Get Results</h3>
                        <p class="text-xs text-purple-700">Receive AI-optimized settings with safety analysis</p>
                    </div>
                </div>
            </section>

            <!-- Step 1: Vehicle Information (Mandatory) -->
            <section id="vehicle-info-section" class="bg-white rounded-md shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 pb-2 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-bold text-gray-900">Step 1: Vehicle Information</h2>
                        <span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-sm">Required</span>
                    </div>
                </div>

                <!-- Main 3-column grid for desktop, stack on mobile -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                    <!-- Column 1: Vehicle Details -->
                    <div class="bg-gray-50 rounded-md border border-gray-200 p-2">
                        <h3 class="font-medium text-gray-800 text-sm mb-2 flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Vehicle Details
                        </h3>
                        
                        <div class="space-y-2">
                            <div>
                                <label for="vehicle-model" class="text-xs font-medium text-gray-700">Model *</label>
                                <select id="vehicle-model" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <option value="">Select...</option>
                                    <option value="e2">e2 (2-pass)</option>
                                    <option value="e4">e4 (4-pass)</option>
                                    <option value="e6">e6 (6-pass)</option>
                                    <option value="eS">eS (2-pass utility)</option>
                                    <option value="eL">eL (4-pass utility)</option>
                                    <option value="eM">eM (Mighty Mite)</option>
                                    <option value="elXD">elXD (Extra Duty)</option>
                                </select>
                            </div>

                            <div>
                                <label for="vehicle-year" class="text-xs font-medium text-gray-700">Year *</label>
                                <select id="vehicle-year" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <option value="">Select...</option>
                                    <option value="2016+">2016+</option>
                                    <option value="2010-2015">2010-2015</option>
                                    <option value="2005-2009">2005-2009</option>
                                    <option value="1999-2004">1999-2004</option>
                                    <option value="pre-1999">Pre-1999</option>
                                </select>
                            </div>

                            <div>
                                <label for="controller-type" class="text-xs font-medium text-gray-700">Controller *</label>
                                <select id="controller-type" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <option value="">Select...</option>
                                    <option value="T2">T2</option>
                                    <option value="T4">T4</option>
                                    <option value="T1">T1 (Legacy)</option>
                                    <option value="unknown">Not Sure</option>
                                </select>
                            </div>

                            <div>
                                <label for="current-speed" class="text-xs font-medium text-gray-700">Current Top Speed *</label>
                                <div class="mt-1 relative">
                                    <input type="number" id="current-speed" min="15" max="40" value="25" 
                                           class="w-full px-2 py-1.5 pr-12 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <span class="absolute inset-y-0 right-0 pr-2 flex items-center text-xs text-gray-500">MPH</span>
                                </div>
                            </div>

                            <!-- Vehicle Classification -->
                            <div id="vehicle-classification" class="mt-3 p-2 bg-white rounded border border-gray-200">
                                <div class="text-xs">
                                    <span class="font-semibold text-green-700">Golf Cart</span>
                                    <p class="text-gray-600 mt-0.5">‚â§25 MPH ‚Ä¢ Local roads only</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Column 2: Motor Details -->
                    <div class="bg-gray-50 rounded-md border border-gray-200 p-2">
                        <h3 class="font-medium text-gray-800 text-sm mb-2 flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Motor Details
                        </h3>
                        
                        <div class="space-y-2">
                            <div>
                                <label for="motor-type" class="text-xs font-medium text-gray-700 flex items-center justify-between">
                                    Type *
                                    <button type="button" id="motor-type-ai-assist" class="text-xs text-blue-600 hover:text-blue-500">
                                        ü§ñ AI
                                    </button>
                                </label>
                                <select id="motor-type" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <option value="">Select...</option>
                                    <option value="dc-stock">DC Stock (3.5HP)</option>
                                    <option value="dc-upgrade">DC Upgrade (5HP+)</option>
                                    <option value="ac-stock">AC Stock</option>
                                    <option value="ac-performance">AC Performance</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <div id="motor-ai-suggestion" class="hidden mt-1 p-1.5 bg-blue-50 text-xs text-blue-700 rounded"></div>
                            </div>
                            
                            <div>
                                <label for="motor-model" class="text-xs font-medium text-gray-700">Model/Part #</label>
                                <input type="text" id="motor-model" placeholder="e.g., GE 5BC59JBS6439" 
                                       class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500">
                            </div>
                            
                            <div>
                                <label for="motor-power" class="text-xs font-medium text-gray-700">Power</label>
                                <div class="mt-1 relative">
                                    <input type="number" id="motor-power" min="1" max="15" step="0.5" placeholder="3.5" 
                                           class="w-full px-2 py-1.5 pr-10 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500">
                                    <span class="absolute inset-y-0 right-0 pr-2 flex items-center text-xs text-gray-500">HP</span>
                                </div>
                            </div>

                            <div>
                                <label for="motor-age" class="text-xs font-medium text-gray-700">Age/Hours</label>
                                <select id="motor-age" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500">
                                    <option value="new">New (<100)</option>
                                    <option value="low">Low (100-500)</option>
                                    <option value="moderate">Moderate (500-2000)</option>
                                    <option value="high">High (2000-5000)</option>
                                    <option value="very-high">Very High (>5000)</option>
                                    <option value="unknown">Unknown</option>
                                </select>
                            </div>

                            <!-- Condition Indicators -->
                            <div class="mt-3 p-2 bg-white rounded border border-gray-200">
                                <label class="text-xs font-medium text-gray-700 mb-1 block">Condition</label>
                                <div class="space-y-1">
                                    <label class="flex items-center text-xs">
                                        <input type="checkbox" id="motor-sparking" class="mr-1.5 text-green-600 focus:ring-green-500">
                                        <span>Sparking/Arcing</span>
                                    </label>
                                    <label class="flex items-center text-xs">
                                        <input type="checkbox" id="motor-noise" class="mr-1.5 text-green-600 focus:ring-green-500">
                                        <span>Unusual noise</span>
                                    </label>
                                    <label class="flex items-center text-xs">
                                        <input type="checkbox" id="motor-overheating" class="mr-1.5 text-green-600 focus:ring-green-500">
                                        <span>Overheating</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Column 3: Battery & Drivetrain -->
                    <div class="bg-gray-50 rounded-md border border-gray-200 p-2">
                        <h3 class="font-medium text-gray-800 text-sm mb-2 flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Battery & Drivetrain
                        </h3>
                        
                        <div class="space-y-2">
                            <div>
                                <label for="battery-voltage" class="text-xs font-medium text-gray-700">Voltage *</label>
                                <select id="battery-voltage" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <option value="">Select...</option>
                                    <option value="48">48V</option>
                                    <option value="60">60V</option>
                                    <option value="72">72V</option>
                                    <option value="82">82V</option>
                                    <option value="96">96V</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="battery-type" class="text-xs font-medium text-gray-700">Type *</label>
                                <select id="battery-type" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <option value="">Select...</option>
                                    <option value="lead-acid">Lead Acid</option>
                                    <option value="agm">AGM</option>
                                    <option value="gel">Gel</option>
                                    <option value="lithium">Lithium</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="battery-capacity" class="text-xs font-medium text-gray-700">Capacity *</label>
                                <div class="mt-1 relative">
                                    <input type="number" id="battery-capacity" min="50" max="500" step="5" placeholder="105" 
                                           class="w-full px-2 py-1.5 pr-10 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <span class="absolute inset-y-0 right-0 pr-2 flex items-center text-xs text-gray-500">Ah</span>
                                </div>
                            </div>
                            
                            <div>
                                <label for="tire-diameter" class="text-xs font-medium text-gray-700">Tire Diameter *</label>
                                <div class="mt-1 relative">
                                    <input type="number" id="tire-diameter" min="18" max="26" step="0.5" placeholder="22.5" 
                                           class="w-full px-2 py-1.5 pr-8 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <span class="absolute inset-y-0 right-0 pr-2 flex items-center text-xs text-gray-500">in</span>
                                </div>
                            </div>
                            
                            <div>
                                <label for="gear-ratio" class="text-xs font-medium text-gray-700">Gear Ratio *</label>
                                <input type="text" id="gear-ratio" placeholder="10.35:1" pattern="[0-9]+\.?[0-9]*:1"
                                       class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                            </div>

                            <div>
                                <label for="motor-last-service" class="text-xs font-medium text-gray-700">Last Service</label>
                                <input type="date" id="motor-last-service" 
                                       class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500">
                            </div>
                        </div>
                    </div>
                </div>
                

                <!-- PDF Upload Section -->
                <div class="mt-3 bg-gray-50 rounded-md border border-gray-200 p-2">
                    <h3 class="font-medium text-gray-800 text-sm mb-2 flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m2 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Import Current Settings (Optional)
                    </h3>
                    <div id="pdf-upload-area" class="border-2 border-dashed border-gray-300 rounded-md p-2 text-center hover:border-green-400 transition-colors">
                        <svg class="mx-auto h-6 w-6 text-gray-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="text-xs text-gray-600">
                            <label for="settings-pdf" class="cursor-pointer">
                                <span class="text-green-600 hover:text-green-500">Upload PDF</span>
                                <span class="text-gray-500"> of current settings</span>
                            </label>
                        </p>
                        <input id="settings-pdf" type="file" accept=".pdf" class="hidden">
                    </div>
                    
                    <div id="pdf-analysis-result" class="hidden mt-2">
                        <div id="pdf-analysis-content" class="text-xs">
                            <div id="pdf-metadata"></div>
                            <div id="pdf-settings-preview" class="mt-1"></div>
                            <div id="pdf-debug-info" class="mt-1"></div>
                        </div>
                    </div>
                </div>

                <div class="mt-3 pt-2 border-t border-gray-200 flex justify-end">
                    <button id="continue-to-planning" class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-1 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed text-sm transition-colors" disabled>
                        Continue to Trip Planning ‚Üí
                    </button>
                </div>
            </section>

            <!-- Step 2: Trip Planning & Optimization -->
            <section id="trip-planning-section" class="hidden">
                <div class="bg-white rounded-md shadow-sm border border-gray-200 p-3 mb-3">
                    <div class="mb-2 pb-2 border-b border-gray-100">
                        <h2 class="text-lg font-bold text-gray-900 mb-1">Step 2: Plan Your Adventure</h2>
                        <p class="text-gray-600 text-sm">Tell us about your trip for optimized controller settings</p>
                    </div>

                    <!-- Quick Actions -->
                    <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-2 mb-4">
                        <button class="quick-action-btn p-2 border border-gray-200 rounded-md hover:border-green-400 hover:bg-green-50 transition-all" data-action="daily-commute">
                            <div class="text-lg mb-1">üè†</div>
                            <h4 class="font-medium text-sm">Daily Commute</h4>
                            <p class="text-xs text-gray-600">Optimize for efficiency</p>
                        </button>
                        
                        <button class="quick-action-btn p-2 border border-gray-200 rounded-md hover:border-green-400 hover:bg-green-50 transition-all" data-action="weekend-outing" onclick="if(unifiedFlow.validateStep1()) { window.location.href='weekend-planner.html'; }">
                            <div class="text-lg mb-1">üå≤</div>
                            <h4 class="font-medium text-sm">Weekend Outing</h4>
                            <p class="text-xs text-gray-600">Open trip planner</p>
                        </button>
                        
                        <button class="quick-action-btn p-2 border border-gray-200 rounded-md hover:border-green-400 hover:bg-green-50 transition-all" data-action="performance">
                            <div class="text-lg mb-1">üèÅ</div>
                            <h4 class="font-medium text-sm">Max Performance</h4>
                            <p class="text-xs text-gray-600">Speed & acceleration</p>
                        </button>
                        
                        <button class="quick-action-btn p-2 border border-gray-200 rounded-md hover:border-green-400 hover:bg-green-50 transition-all" onclick="window.location.href='accessories-config.html'">
                            <div class="text-lg mb-1">üîß</div>
                            <h4 class="font-medium text-sm">Accessories</h4>
                            <p class="text-xs text-gray-600">Manage add-ons</p>
                        </button>
                        
                        <button class="quick-action-btn p-2 border border-gray-200 rounded-md hover:border-green-400 hover:bg-green-50 transition-all" onclick="window.location.href='driving-modes.html'">
                            <div class="text-lg mb-1">üéØ</div>
                            <h4 class="font-medium text-sm">Driving Modes</h4>
                            <p class="text-xs text-gray-600">Special scenarios</p>
                        </button>
                        
                        <button class="quick-action-btn p-2 border border-gray-200 rounded-md hover:border-green-400 hover:bg-green-50 transition-all" onclick="window.location.href='mobile-route-map.html'">
                            <div class="text-lg mb-1">üì±</div>
                            <h4 class="font-medium text-sm">Mobile Routes</h4>
                            <p class="text-xs text-gray-600">Mobile mapping</p>
                        </button>
                    </div>


                    <!-- MCP Integration -->
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h4 class="text-sm font-medium text-blue-900">AI-Powered Optimization</h4>
                                <p class="text-sm text-blue-700 mt-1">
                                    Our MCP integration analyzes weather, terrain, and your vehicle specs to provide optimal settings.
                                </p>
                                <button id="enable-mcp" class="mt-2 text-sm text-blue-600 hover:text-blue-500 underline">
                                    Configure MCP Connection
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-2 border-t border-gray-200 flex justify-between items-center">
                        <button id="back-to-vehicle" class="px-3 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-sm transition-colors">
                            ‚Üê Back
                        </button>
                        <button id="generate-settings" class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-1 focus:ring-green-500 text-sm transition-colors">
                            Generate Optimized Settings
                        </button>
                    </div>
                </div>
            </section>

            <!-- Step 3: Results & Settings -->
            <section id="results-section" class="hidden">
                <!-- Results will be dynamically generated here -->
            </section>

            <!-- Settings & Advanced Features Section -->
            <section id="settings-section" class="hidden">
                <div class="bg-white rounded-md shadow-sm border border-gray-200 p-3 mb-3">
                    <div class="flex items-center justify-between mb-3 pb-2 border-b border-gray-100">
                        <h2 class="text-lg font-bold text-gray-900">Settings & Advanced Features</h2>
                        <button onclick="document.getElementById('settings-section').classList.add('hidden')" class="text-gray-500 hover:text-gray-700 p-1 rounded transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4">
                        <!-- MCP Integration Settings -->
                        <div class="space-y-4">
                            <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg p-4 text-white">
                                <div class="flex items-center mb-3">
                                    <span class="text-xl mr-2">ü§ñ</span>
                                    <h3 class="font-bold">Model Context Protocol (MCP)</h3>
                                </div>
                                <p class="text-sm opacity-90 mb-4">
                                    Enhanced AI optimization with advanced context awareness for superior results
                                </p>
                                
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm">MCP Integration</span>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="mcp-enabled" class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        </label>
                                    </div>
                                    
                                    <button id="configure-mcp" class="w-full bg-white text-purple-600 px-4 py-2 rounded font-semibold hover:bg-gray-100 transition-colors">
                                        Configure MCP Connection
                                    </button>
                                    
                                    <div class="text-xs opacity-75 space-y-1">
                                        <div class="flex items-center">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                            Real-time Analysis
                                        </div>
                                        <div class="flex items-center">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                            Smart Recommendations
                                        </div>
                                        <div class="flex items-center">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                            Enhanced Accuracy
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- General Settings -->
                        <div class="space-y-4">
                            <h3 class="font-semibold text-gray-800">General Settings</h3>
                            
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <label for="units-system" class="text-sm font-medium text-gray-700">Units System</label>
                                    <select id="units-system" class="border border-gray-300 rounded px-2 py-1 text-sm">
                                        <option value="imperial">Imperial (MPH, ¬∞F)</option>
                                        <option value="metric">Metric (KM/H, ¬∞C)</option>
                                    </select>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <label for="safety-mode" class="text-sm font-medium text-gray-700">Safety Mode</label>
                                    <select id="safety-mode" class="border border-gray-300 rounded px-2 py-1 text-sm">
                                        <option value="conservative">Conservative</option>
                                        <option value="balanced" selected>Balanced</option>
                                        <option value="performance">Performance</option>
                                    </select>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Enable Notifications</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="notifications-enabled" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Auto-save Settings</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="autosave-enabled" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>
                            </div>

                            <div class="pt-4 border-t">
                                <h4 class="font-medium text-gray-700 mb-2">Data & Privacy</h4>
                                <div class="space-y-2 text-sm text-gray-600">
                                    <button class="text-blue-600 hover:underline">Export Settings</button>
                                    <button class="text-blue-600 hover:underline">Import Settings</button>
                                    <button class="text-red-600 hover:underline">Clear All Data</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-2 border-t border-gray-200 flex justify-end">
                        <button onclick="document.getElementById('settings-section').classList.add('hidden')" class="px-3 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 text-sm transition-colors">
                            Close Settings
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-2 px-4 mt-4 no-print border-t border-gray-700">
        <div class="container mx-auto text-center text-xs">
            <p>¬© 2024 GEM T2 Smart Optimizer. Not affiliated with GEM, Polaris, or General Electric.</p>
            <p class="mt-1">Use at your own risk. Always follow manufacturer safety guidelines.</p>
        </div>
    </footer>

    <!-- Load JavaScript modules -->
    <script>
        // Set PDF.js worker
        if (typeof pdfjsLib !== 'undefined') {
            pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
        }
    </script>
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase-profile-manager.js"></script>
    <script src="js/community-manager.js"></script>
    
    <script src="js/shared-utils.js"></script>
    <script src="js/secure-storage.js"></script>
    <script src="js/api-manager.js"></script>
    <script src="js/tensorflow-ml-engine.js"></script>
    <script src="js/rule-based-optimizer.js"></script>
    <script src="js/optimization-cache.js"></script>
    <script src="js/fallback-calculations.js"></script>
    <script src="js/fallback-system.js"></script>
    <script src="js/api-integration.js"></script>
    <script src="js/mcp-config.js"></script>
    <script src="js/weather-service.js"></script>
    <script src="js/terrain-service.js"></script>
    <script src="js/optimizer.js"></script>
    <script src="js/trip-optimizer.js"></script>
    <script src="js/pdf-parser.js"></script>
    <script src="js/vehicle-classifier.js"></script>
    <script src="js/accessories-manager.js"></script>
    <script src="js/driving-modes.js"></script>
    <script src="js/enhanced-pdf-analyzer.js"></script>
    <script src="js/ai-assistant.js"></script>
    <script src="js/ai-ui-integration.js"></script>
    <script src="js/unified-flow.js"></script>
    
    <script>
        // Enhanced PDF upload handler with preview
        document.addEventListener('DOMContentLoaded', function() {
            const pdfInput = document.getElementById('settings-pdf');
            const pdfAnalysisResult = document.getElementById('pdf-analysis-result');
            const pdfMetadata = document.getElementById('pdf-metadata');
            const pdfSettingsPreview = document.getElementById('pdf-settings-preview');
            const pdfDebugInfo = document.getElementById('pdf-debug-info');
            
            if (pdfInput) {
                pdfInput.addEventListener('change', async function(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    console.log('PDF file selected:', file.name);
                    pdfAnalysisResult.classList.add('hidden');
                    
                    try {
                        // Show loading state
                        pdfMetadata.innerHTML = '<div class="text-blue-600">üìÑ Analyzing PDF...</div>';
                        pdfAnalysisResult.classList.remove('hidden');
                        
                        // Initialize PDF parser
                        const parser = new PDFParser();
                        
                        // Parse the PDF
                        const result = await parser.parsePDF(file);
                        console.log('PDF parsing result:', result);
                        
                        if (result.success) {
                            displayPDFAnalysisSuccess(result);
                            
                            // Store parsed settings for use in optimization
                            window.importedSettings = result.settings;
                            
                        } else {
                            displayPDFAnalysisError(result);
                        }
                        
                    } catch (error) {
                        console.error('PDF analysis error:', error);
                        displayPDFAnalysisError({ 
                            error: error.message, 
                            suggestions: ['Please check that the PDF is not corrupted and contains controller settings'] 
                        });
                    }
                });
            }
            
            function displayPDFAnalysisSuccess(result) {
                // Display metadata
                const metadata = result.metadata;
                pdfMetadata.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <strong>${metadata.fileName}</strong>
                            <span class="text-xs text-gray-600">(${metadata.totalFunctions} functions found)</span>
                        </div>
                        <div class="text-xs">
                            Confidence: <span class="font-medium">${Math.round(metadata.confidence * 100)}%</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 mt-1">
                        Methods: ${metadata.extractionMethods.join(', ')}
                    </div>
                `;
                
                // Display settings preview
                displaySettingsPreview(result.preview);
                
                // Display debug info if available
                if (result.debugInfo && result.debugInfo.detectionResults) {
                    const debugHtml = `
                        <details class="cursor-pointer">
                            <summary class="font-medium">Debug Information (click to expand)</summary>
                            <div class="mt-2 space-y-1">
                                <div>Pages processed: ${metadata.pageCount}</div>
                                <div>Valid functions: ${metadata.validFunctions}</div>
                                <div>Invalid functions: ${metadata.invalidFunctions}</div>
                                <div>Extraction methods used: ${metadata.extractionMethods.length}</div>
                            </div>
                        </details>
                    `;
                    pdfDebugInfo.innerHTML = debugHtml;
                } else {
                    pdfDebugInfo.innerHTML = '';
                }
            }
            
            function displayPDFAnalysisError(result) {
                pdfMetadata.innerHTML = `
                    <div class="text-red-600">
                        <strong>‚ùå Analysis Failed</strong>
                        <div class="text-sm mt-1">${result.error || 'Unknown error occurred'}</div>
                    </div>
                `;
                
                if (result.suggestions && result.suggestions.length > 0) {
                    const suggestionsHtml = result.suggestions.map(s => `<li>${s}</li>`).join('');
                    pdfSettingsPreview.innerHTML = `
                        <div class="text-sm text-red-700">
                            <strong>Suggestions:</strong>
                            <ul class="list-disc list-inside mt-1 space-y-1">${suggestionsHtml}</ul>
                        </div>
                    `;
                } else {
                    pdfSettingsPreview.innerHTML = '';
                }
                
                // Show fallback info if available
                if (result.fallback && result.fallback.success) {
                    pdfDebugInfo.innerHTML = `
                        <div class="text-amber-600">
                            <strong>Fallback extraction found ${Object.keys(result.fallback.settings).length} functions</strong>
                            <div class="text-xs mt-1">Using basic pattern matching</div>
                        </div>
                    `;
                    window.importedSettings = result.fallback.settings;
                } else {
                    pdfDebugInfo.innerHTML = '';
                }
            }
            
            function displaySettingsPreview(preview) {
                if (!preview || preview.length === 0) {
                    pdfSettingsPreview.innerHTML = '<div class="text-gray-600">No settings preview available</div>';
                    return;
                }
                
                // Group preview into chunks for better display
                const chunks = [];
                for (let i = 0; i < preview.length; i += 6) {
                    chunks.push(preview.slice(i, i + 6));
                }
                
                const previewHtml = chunks.map(chunk => {
                    const itemsHtml = chunk.map(item => {
                        const rangeText = item.range ? `(${item.range[0]}-${item.range[1]})` : '';
                        const statusClass = item.isInRange ? 'text-green-700' : 'text-red-600';
                        return `
                            <div class="flex justify-between items-center text-xs">
                                <span class="font-medium">F.${item.function}</span>
                                <span class="${statusClass}">${item.value}</span>
                            </div>
                        `;
                    }).join('');
                    
                    return `<div class="grid grid-cols-2 gap-x-4 gap-y-1">${itemsHtml}</div>`;
                }).join('<div class="border-t border-green-200 my-2"></div>');
                
                const showAllButton = preview.length > 12 ? `
                    <button onclick="toggleFullPreview()" class="text-xs text-blue-600 hover:underline mt-2">
                        Show all ${preview.length} functions
                    </button>
                ` : '';
                
                pdfSettingsPreview.innerHTML = `
                    <div class="bg-white bg-opacity-50 rounded p-2">
                        <div class="font-medium text-xs mb-2">Settings Preview (${preview.length} functions):</div>
                        <div id="preview-content">${previewHtml}</div>
                        ${showAllButton}
                    </div>
                `;
            }
            
            // Global function for toggling full preview
            window.toggleFullPreview = function() {
                const fullData = window.currentPreviewData;
                if (!fullData) return;
                
                const content = document.getElementById('preview-content');
                if (content.dataset.expanded === 'true') {
                    // Show condensed version
                    displaySettingsPreview(fullData.slice(0, 12));
                    content.dataset.expanded = 'false';
                } else {
                    // Show full version
                    displaySettingsPreview(fullData);
                    content.dataset.expanded = 'true';
                }
            };
        });
    </script>
</body>
</html>