<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GEM T2 Optimizer - Smart Weekend Planner</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <link rel="stylesheet" href="styles.css">
</head>
<body class="bg-gray-50">
    <!-- Header -->
    <header class="bg-green-700 text-white py-2 px-4 no-print border-b border-green-600">
        <div class="container mx-auto">
            <div class="flex items-center justify-between">
                <div>
                    <h1 class="text-lg font-bold">üöó‚ö° GEM T2 Smart Optimizer</h1>
                    <p class="text-xs opacity-90">AI-Powered Weekend Planning & Controller Optimization</p>
                </div>
                <nav class="hidden md:flex space-x-2">
                    <a href="user-guide.html" class="text-xs hover:underline px-2 py-1 rounded hover:bg-green-600 transition-colors">üìö User Guide</a>
                    <a href="community.html" class="text-xs hover:underline px-2 py-1 rounded hover:bg-green-600 transition-colors">üåü Community</a>
                    <a href="weekend-planner.html" class="text-xs hover:underline px-2 py-1 rounded hover:bg-green-600 transition-colors">Weekend Planner</a>
                    <a href="reference-guide.html" class="text-xs hover:underline px-2 py-1 rounded hover:bg-green-600 transition-colors">Reference Guide</a>
                    <a href="accessories-config.html" class="text-xs hover:underline px-2 py-1 rounded hover:bg-green-600 transition-colors">Accessories</a>
                </nav>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-2">
        <!-- AI-Powered Optimization Banner -->
        <div class="max-w-4xl mx-auto mb-3 border-b border-gray-200 pb-2">
            <div class="bg-gradient-to-r from-green-500 to-blue-500 rounded-md p-2 text-white">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <span class="text-sm mr-2">ü§ñ</span>
                        <div>
                            <h2 class="font-medium text-sm">AI-Powered Optimization</h2>
                            <p class="text-xs opacity-90">Smart controller settings with local AI and rule-based analysis</p>
                        </div>
                    </div>
                    <button onclick="document.getElementById('settings-section').classList.remove('hidden'); document.getElementById('settings-section').scrollIntoView({behavior: 'smooth'})" class="bg-white bg-opacity-20 hover:bg-opacity-30 px-2 py-1 rounded text-xs transition-colors">
                        Settings
                    </button>
                </div>
            </div>
        </div>

        <!-- Main Flow Container -->
        <div id="main-flow" class="max-w-4xl mx-auto">
            
            <!-- Welcome Section -->
            <section id="welcome-section" class="bg-white rounded-md shadow-sm border border-gray-200 p-3 mb-3">
                <div class="text-center mb-3">
                    <h2 class="text-lg font-bold text-gray-900 mb-1">Welcome to the Future of GEM Optimization</h2>
                    <p class="text-sm text-gray-600">AI-powered controller optimization in 3 simple steps</p>
                </div>
                
                <div class="grid md:grid-cols-3 gap-2">
                    <div class="bg-gradient-to-br from-blue-50 to-blue-100 p-2 rounded-md border border-blue-200">
                        <div class="text-blue-600 text-lg mb-1">1Ô∏è‚É£</div>
                        <h3 class="font-medium text-blue-900 mb-1 text-sm">Vehicle Info</h3>
                        <p class="text-xs text-blue-700">Enter your GEM details for personalized optimization</p>
                    </div>
                    <div class="bg-gradient-to-br from-green-50 to-green-100 p-2 rounded-md border border-green-200">
                        <div class="text-green-600 text-lg mb-1">2Ô∏è‚É£</div>
                        <h3 class="font-medium text-green-900 mb-1 text-sm">Trip Planning</h3>
                        <p class="text-xs text-green-700">Choose your usage pattern or plan a weekend trip</p>
                    </div>
                    <div class="bg-gradient-to-br from-purple-50 to-purple-100 p-2 rounded-md border border-purple-200">
                        <div class="text-purple-600 text-lg mb-1">3Ô∏è‚É£</div>
                        <h3 class="font-medium text-purple-900 mb-1 text-sm">Get Results</h3>
                        <p class="text-xs text-purple-700">Receive AI-optimized settings with safety analysis</p>
                    </div>
                </div>
            </section>

            <!-- Step 1: Vehicle Information (Mandatory) -->
            <section id="vehicle-info-section" class="bg-white rounded-md shadow-sm border border-gray-200 p-3 mb-3">
                <div class="mb-2 pb-2 border-b border-gray-100">
                    <div class="flex items-center justify-between">
                        <h2 class="text-lg font-bold text-gray-900">Step 1: Vehicle Information</h2>
                        <span class="text-xs bg-red-100 text-red-700 px-2 py-1 rounded-sm">Required</span>
                    </div>
                </div>

                <!-- Main 3-column grid for desktop, stack on mobile -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-2">
                    <!-- Column 1: Vehicle Details -->
                    <div class="bg-gray-50 rounded-md border border-gray-200 p-2">
                        <h3 class="font-medium text-gray-800 text-sm mb-2 flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            Vehicle Details
                        </h3>
                        
                        <div class="space-y-2">
                            <div>
                                <label for="vehicle-model" class="text-xs font-medium text-gray-700">Model *</label>
                                <select id="vehicle-model" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <option value="">Select...</option>
                                    <option value="e2">e2 (2-pass)</option>
                                    <option value="e4">e4 (4-pass)</option>
                                    <option value="e6">e6 (6-pass)</option>
                                    <option value="eS">eS (2-pass utility)</option>
                                    <option value="eL">eL (4-pass utility)</option>
                                    <option value="eM">eM (Mighty Mite)</option>
                                    <option value="elXD">elXD (Extra Duty)</option>
                                </select>
                            </div>

                            <div>
                                <label for="vehicle-year" class="text-xs font-medium text-gray-700">Year *</label>
                                <select id="vehicle-year" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <option value="">Select...</option>
                                    <option value="2016+">2016+</option>
                                    <option value="2010-2015">2010-2015</option>
                                    <option value="2005-2009">2005-2009</option>
                                    <option value="1999-2004">1999-2004</option>
                                    <option value="pre-1999">Pre-1999</option>
                                </select>
                            </div>

                            <div>
                                <label for="controller-type" class="text-xs font-medium text-gray-700">Controller *</label>
                                <select id="controller-type" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <option value="">Select...</option>
                                    <option value="T2">T2</option>
                                    <option value="T4">T4</option>
                                    <option value="T1">T1 (Legacy)</option>
                                    <option value="unknown">Not Sure</option>
                                </select>
                            </div>

                            <div>
                                <label for="current-speed" class="text-xs font-medium text-gray-700">Current Top Speed *</label>
                                <div class="mt-1 relative">
                                    <input type="number" id="current-speed" min="15" max="40" value="25" 
                                           class="w-full px-2 py-1.5 pr-12 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <span class="absolute inset-y-0 right-0 pr-2 flex items-center text-xs text-gray-500">MPH</span>
                                </div>
                            </div>

                            <!-- Vehicle Classification -->
                            <div id="vehicle-classification" class="mt-3 p-2 bg-white rounded border border-gray-200">
                                <div class="text-xs">
                                    <span class="font-semibold text-green-700">Golf Cart</span>
                                    <p class="text-gray-600 mt-0.5">‚â§25 MPH ‚Ä¢ Local roads only</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Column 2: Motor Details -->
                    <div class="bg-gray-50 rounded-md border border-gray-200 p-2">
                        <h3 class="font-medium text-gray-800 text-sm mb-2 flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path>
                            </svg>
                            Motor Details
                        </h3>
                        
                        <div class="space-y-2">
                            <div>
                                <label for="motor-type" class="text-xs font-medium text-gray-700 flex items-center justify-between">
                                    Type *
                                    <button type="button" id="motor-type-ai-assist" class="text-xs text-blue-600 hover:text-blue-500">
                                        ü§ñ AI
                                    </button>
                                </label>
                                <select id="motor-type" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <option value="">Select...</option>
                                    <option value="dc-stock">DC Stock (3.5HP)</option>
                                    <option value="dc-upgrade">DC Upgrade (5HP+)</option>
                                    <option value="ac-stock">AC Stock</option>
                                    <option value="ac-performance">AC Performance</option>
                                    <option value="custom">Custom</option>
                                </select>
                                <div id="motor-ai-suggestion" class="hidden mt-1 p-1.5 bg-blue-50 text-xs text-blue-700 rounded"></div>
                            </div>
                            
                            <div>
                                <label for="motor-model" class="text-xs font-medium text-gray-700">Model/Part #</label>
                                <input type="text" id="motor-model" placeholder="e.g., GE 5BC59JBS6439" 
                                       class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500">
                            </div>
                            
                            <div>
                                <label for="motor-power" class="text-xs font-medium text-gray-700">Power</label>
                                <div class="mt-1 relative">
                                    <input type="number" id="motor-power" min="1" max="15" step="0.5" placeholder="3.5" 
                                           class="w-full px-2 py-1.5 pr-10 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500">
                                    <span class="absolute inset-y-0 right-0 pr-2 flex items-center text-xs text-gray-500">HP</span>
                                </div>
                            </div>

                            <div>
                                <label for="motor-age" class="text-xs font-medium text-gray-700">Age/Hours</label>
                                <select id="motor-age" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500">
                                    <option value="new">New (<100)</option>
                                    <option value="low">Low (100-500)</option>
                                    <option value="moderate">Moderate (500-2000)</option>
                                    <option value="high">High (2000-5000)</option>
                                    <option value="very-high">Very High (>5000)</option>
                                    <option value="unknown">Unknown</option>
                                </select>
                            </div>

                            <!-- Condition Indicators -->
                            <div class="mt-3 p-2 bg-white rounded border border-gray-200">
                                <label class="text-xs font-medium text-gray-700 mb-1 block">Condition</label>
                                <div class="space-y-1">
                                    <label class="flex items-center text-xs">
                                        <input type="checkbox" id="motor-sparking" class="mr-1.5 text-green-600 focus:ring-green-500">
                                        <span>Sparking/Arcing</span>
                                    </label>
                                    <label class="flex items-center text-xs">
                                        <input type="checkbox" id="motor-noise" class="mr-1.5 text-green-600 focus:ring-green-500">
                                        <span>Unusual noise</span>
                                    </label>
                                    <label class="flex items-center text-xs">
                                        <input type="checkbox" id="motor-overheating" class="mr-1.5 text-green-600 focus:ring-green-500">
                                        <span>Overheating</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Column 3: Battery & Drivetrain -->
                    <div class="bg-gray-50 rounded-md border border-gray-200 p-2">
                        <h3 class="font-medium text-gray-800 text-sm mb-2 flex items-center">
                            <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                            </svg>
                            Battery & Drivetrain
                        </h3>
                        
                        <div class="space-y-2">
                            <div>
                                <label for="battery-voltage" class="text-xs font-medium text-gray-700">Voltage *</label>
                                <select id="battery-voltage" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <option value="">Select...</option>
                                    <option value="48">48V</option>
                                    <option value="60">60V</option>
                                    <option value="72">72V</option>
                                    <option value="82">82V</option>
                                    <option value="96">96V</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="battery-type" class="text-xs font-medium text-gray-700">Type *</label>
                                <select id="battery-type" class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <option value="">Select...</option>
                                    <option value="lead-acid">Lead Acid</option>
                                    <option value="agm">AGM</option>
                                    <option value="gel">Gel</option>
                                    <option value="lithium">Lithium</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="battery-capacity" class="text-xs font-medium text-gray-700">Capacity *</label>
                                <div class="mt-1 relative">
                                    <input type="number" id="battery-capacity" min="50" max="500" step="5" placeholder="105" 
                                           class="w-full px-2 py-1.5 pr-10 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <span class="absolute inset-y-0 right-0 pr-2 flex items-center text-xs text-gray-500">Ah</span>
                                </div>
                            </div>
                            
                            <div>
                                <label for="tire-diameter" class="text-xs font-medium text-gray-700">Tire Diameter *</label>
                                <div class="mt-1 relative">
                                    <input type="number" id="tire-diameter" min="18" max="26" step="0.5" placeholder="22.5" 
                                           class="w-full px-2 py-1.5 pr-8 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                                    <span class="absolute inset-y-0 right-0 pr-2 flex items-center text-xs text-gray-500">in</span>
                                </div>
                            </div>
                            
                            <div>
                                <label for="gear-ratio" class="text-xs font-medium text-gray-700">Gear Ratio *</label>
                                <input type="text" id="gear-ratio" placeholder="10.35:1" pattern="[0-9]+\.?[0-9]*:1"
                                       class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500" required>
                            </div>

                            <div>
                                <label for="motor-last-service" class="text-xs font-medium text-gray-700">Last Service</label>
                                <input type="date" id="motor-last-service" 
                                       class="mt-1 w-full px-2 py-1.5 text-sm border border-gray-300 rounded focus:outline-none focus:ring-1 focus:ring-green-500">
                            </div>
                        </div>
                    </div>
                </div>
                

                <!-- Current Settings Section -->
                <div class="mt-3 bg-gray-50 rounded-md border border-gray-200 p-2">
                    <h3 class="font-medium text-gray-800 text-sm mb-2 flex items-center">
                        <svg class="w-3 h-3 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m2 0a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                        </svg>
                        Import Current Settings (Optional)
                    </h3>
                    
                    <!-- Settings Input Options -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-2 mb-3">
                        <button id="pdf-upload-btn" class="p-2 border border-gray-300 rounded-md hover:border-green-400 hover:bg-green-50 transition-colors text-center">
                            <svg class="mx-auto h-4 w-4 text-gray-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                            </svg>
                            <div class="text-xs font-medium">Upload PDF</div>
                            <div class="text-xs text-gray-500">Sentry/Export file</div>
                        </button>
                        
                        <button id="manual-entry-btn" class="p-2 border border-gray-300 rounded-md hover:border-blue-400 hover:bg-blue-50 transition-colors text-center">
                            <svg class="mx-auto h-4 w-4 text-gray-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"></path>
                            </svg>
                            <div class="text-xs font-medium">Manual Entry</div>
                            <div class="text-xs text-gray-500">Enter key values</div>
                        </button>
                        
                        <button id="factory-defaults-btn" class="p-2 border border-gray-300 rounded-md hover:border-purple-400 hover:bg-purple-50 transition-colors text-center">
                            <svg class="mx-auto h-4 w-4 text-gray-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
                            </svg>
                            <div class="text-xs font-medium">Factory Defaults</div>
                            <div class="text-xs text-gray-500">Standard values</div>
                        </button>
                        
                        <button id="sample-data-btn" class="p-2 border border-gray-300 rounded-md hover:border-orange-400 hover:bg-orange-50 transition-colors text-center">
                            <svg class="mx-auto h-4 w-4 text-gray-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                            </svg>
                            <div class="text-xs font-medium">Use Sample Data</div>
                            <div class="text-xs text-gray-500">Test configurations</div>
                        </button>
                    </div>
                    
                    <!-- PDF Upload Area (hidden by default) -->
                    <div id="pdf-upload-area" class="hidden border-2 border-dashed border-gray-300 rounded-md p-2 text-center hover:border-green-400 transition-colors">
                        <svg class="mx-auto h-6 w-6 text-gray-400 mb-1" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path>
                        </svg>
                        <p class="text-xs text-gray-600">
                            <label for="settings-pdf" class="cursor-pointer">
                                <span class="text-green-600 hover:text-green-500">Upload PDF</span>
                                <span class="text-gray-500"> of current settings</span>
                            </label>
                        </p>
                        <input id="settings-pdf" type="file" accept=".pdf" class="hidden">
                        <button id="cancel-pdf-upload" class="mt-2 text-xs text-gray-500 hover:text-gray-700 underline">Cancel</button>
                    </div>
                    
                    <!-- Manual Entry Form (hidden by default) -->
                    <div id="manual-entry-form" class="hidden border border-blue-200 rounded-md p-3 bg-blue-50">
                        <div class="flex items-center justify-between mb-2">
                            <h4 class="font-medium text-blue-900 text-sm">Manual Entry - Key Settings</h4>
                            <button id="cancel-manual-entry" class="text-xs text-blue-600 hover:text-blue-800 underline">Cancel</button>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-2">
                            <div>
                                <label for="manual-f1" class="block text-xs font-medium text-blue-800">F.1 MPH Scaling</label>
                                <input type="number" id="manual-f1" min="15" max="200" placeholder="100" 
                                       class="mt-1 w-full px-2 py-1 text-sm border border-blue-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <div class="text-xs text-blue-600 mt-0.5">15-200</div>
                            </div>
                            <div>
                                <label for="manual-f3" class="block text-xs font-medium text-blue-800">F.3 Acceleration</label>
                                <input type="number" id="manual-f3" min="8" max="40" placeholder="15" 
                                       class="mt-1 w-full px-2 py-1 text-sm border border-blue-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <div class="text-xs text-blue-600 mt-0.5">8-40</div>
                            </div>
                            <div>
                                <label for="manual-f4" class="block text-xs font-medium text-blue-800">F.4 Max Current</label>
                                <input type="number" id="manual-f4" min="180" max="400" placeholder="245" 
                                       class="mt-1 w-full px-2 py-1 text-sm border border-blue-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <div class="text-xs text-blue-600 mt-0.5">180-400</div>
                            </div>
                            <div>
                                <label for="manual-f7" class="block text-xs font-medium text-blue-800">F.7 Min Field</label>
                                <input type="number" id="manual-f7" min="51" max="120" placeholder="70" 
                                       class="mt-1 w-full px-2 py-1 text-sm border border-blue-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <div class="text-xs text-blue-600 mt-0.5">51-120</div>
                            </div>
                            <div>
                                <label for="manual-f15" class="block text-xs font-medium text-blue-800">F.15 Battery Volts</label>
                                <input type="number" id="manual-f15" min="48" max="96" placeholder="72" 
                                       class="mt-1 w-full px-2 py-1 text-sm border border-blue-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <div class="text-xs text-blue-600 mt-0.5">48-96</div>
                            </div>
                            <div>
                                <label for="manual-f20" class="block text-xs font-medium text-blue-800">F.20 Overspeed</label>
                                <input type="number" id="manual-f20" min="25" max="50" placeholder="30" 
                                       class="mt-1 w-full px-2 py-1 text-sm border border-blue-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <div class="text-xs text-blue-600 mt-0.5">25-50</div>
                            </div>
                            <div>
                                <label for="manual-f24" class="block text-xs font-medium text-blue-800">F.24 Field Weak</label>
                                <input type="number" id="manual-f24" min="25" max="85" placeholder="50" 
                                       class="mt-1 w-full px-2 py-1 text-sm border border-blue-300 rounded focus:outline-none focus:ring-1 focus:ring-blue-500">
                                <div class="text-xs text-blue-600 mt-0.5">25-85</div>
                            </div>
                            <div class="flex items-end">
                                <button id="save-manual-entry" class="w-full px-2 py-1.5 bg-blue-600 text-white rounded text-xs hover:bg-blue-700 transition-colors">
                                    Save Settings
                                </button>
                            </div>
                        </div>
                        <div class="mt-2 text-xs text-blue-700">
                            üí° These are the most critical settings for optimization. Leave blank to use defaults.
                        </div>
                    </div>
                    
                    <!-- Sample Data Selection Modal (hidden by default) -->
                    <div id="sample-data-modal" class="hidden border border-orange-200 rounded-md p-3 bg-orange-50">
                        <div class="flex items-center justify-between mb-3">
                            <h4 class="font-medium text-orange-900 text-sm">Choose Sample Configuration</h4>
                            <button id="cancel-sample-data" class="text-xs text-orange-600 hover:text-orange-800 underline">Cancel</button>
                        </div>
                        
                        <div class="space-y-3">
                            <div class="border border-orange-200 rounded p-2 bg-white hover:bg-orange-25 cursor-pointer transition-colors" onclick="selectSampleConfig('stock_e4')">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0 w-8 h-8 bg-blue-100 rounded-full flex items-center justify-center mr-3">
                                        <span class="text-xs font-bold text-blue-800">üè≠</span>
                                    </div>
                                    <div class="flex-grow">
                                        <div class="font-medium text-sm text-orange-900">Stock GEM e4 (72V Lead-Acid)</div>
                                        <div class="text-xs text-orange-700 mt-1">Factory configuration for 4-passenger GEM with standard lead-acid batteries</div>
                                        <div class="text-xs text-orange-600 mt-1">25 MPH max ‚Ä¢ 72V ‚Ä¢ Standard performance</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="border border-orange-200 rounded p-2 bg-white hover:bg-orange-25 cursor-pointer transition-colors" onclick="selectSampleConfig('lithium_upgrade')">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0 w-8 h-8 bg-green-100 rounded-full flex items-center justify-center mr-3">
                                        <span class="text-xs font-bold text-green-800">‚ö°</span>
                                    </div>
                                    <div class="flex-grow">
                                        <div class="font-medium text-sm text-orange-900">Lithium Upgrade Setup</div>
                                        <div class="text-xs text-orange-700 mt-1">Performance-optimized settings for lithium battery conversion</div>
                                        <div class="text-xs text-orange-600 mt-1">30+ MPH ‚Ä¢ Enhanced acceleration ‚Ä¢ Extended range</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="border border-orange-200 rounded p-2 bg-white hover:bg-orange-25 cursor-pointer transition-colors" onclick="selectSampleConfig('large_tire_setup')">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0 w-8 h-8 bg-purple-100 rounded-full flex items-center justify-center mr-3">
                                        <span class="text-xs font-bold text-purple-800">üöó</span>
                                    </div>
                                    <div class="flex-grow">
                                        <div class="font-medium text-sm text-orange-900">Large Tire Setup</div>
                                        <div class="text-xs text-orange-700 mt-1">Optimized for 23"+ tires with adjusted gear ratios and speed scaling</div>
                                        <div class="text-xs text-orange-600 mt-1">Higher top speed ‚Ä¢ Adjusted for tire size ‚Ä¢ Better traction</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="border border-orange-200 rounded p-2 bg-white hover:bg-orange-25 cursor-pointer transition-colors" onclick="selectSampleConfig('performance_tuned')">
                                <div class="flex items-start">
                                    <div class="flex-shrink-0 w-8 h-8 bg-red-100 rounded-full flex items-center justify-center mr-3">
                                        <span class="text-xs font-bold text-red-800">üèÅ</span>
                                    </div>
                                    <div class="flex-grow">
                                        <div class="font-medium text-sm text-orange-900">Performance Tuned</div>
                                        <div class="text-xs text-orange-700 mt-1">Aggressive settings for maximum performance and speed</div>
                                        <div class="text-xs text-orange-600 mt-1">35+ MPH ‚Ä¢ Fast acceleration ‚Ä¢ Track-ready setup</div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-3 text-xs text-orange-700 bg-orange-100 p-2 rounded">
                            üí° These are realistic configurations used by GEM owners. Perfect for testing the optimizer without needing your actual settings.
                        </div>
                    </div>
                    
                    <!-- Results/Status Area -->
                    <div id="settings-input-result" class="hidden mt-2">
                        <div id="settings-input-content" class="text-xs">
                            <div id="settings-metadata"></div>
                            <div id="settings-preview" class="mt-1"></div>
                            <div id="settings-debug-info" class="mt-1"></div>
                        </div>
                    </div>
                </div>

                <div class="mt-3 pt-2 border-t border-gray-200 flex justify-end">
                    <button id="continue-to-planning" class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-1 focus:ring-green-500 disabled:opacity-50 disabled:cursor-not-allowed text-sm transition-colors" disabled>
                        Continue to Trip Planning ‚Üí
                    </button>
                </div>
            </section>

            <!-- Step 2: Trip Planning & Optimization -->
            <section id="trip-planning-section" class="hidden">
                <div class="bg-white rounded-md shadow-sm border border-gray-200 p-3 mb-3">
                    <div class="mb-2 pb-2 border-b border-gray-100">
                        <h2 class="text-lg font-bold text-gray-900 mb-1">Step 2: Plan Your Adventure</h2>
                        <p class="text-gray-600 text-sm">Tell us about your trip for optimized controller settings</p>
                    </div>

                    <!-- Quick Actions -->
                    <div class="grid grid-cols-2 md:grid-cols-3 xl:grid-cols-6 gap-2 mb-4">
                        <button class="quick-action-btn p-2 border border-gray-200 rounded-md hover:border-green-400 hover:bg-green-50 transition-all" data-action="daily-commute">
                            <div class="text-lg mb-1">üè†</div>
                            <h4 class="font-medium text-sm">Daily Commute</h4>
                            <p class="text-xs text-gray-600">Optimize for efficiency</p>
                        </button>
                        
                        <button class="quick-action-btn p-2 border border-gray-200 rounded-md hover:border-green-400 hover:bg-green-50 transition-all" data-action="weekend-outing" onclick="if(unifiedFlow.validateStep1()) { window.location.href='weekend-planner.html'; }">
                            <div class="text-lg mb-1">üå≤</div>
                            <h4 class="font-medium text-sm">Weekend Outing</h4>
                            <p class="text-xs text-gray-600">Open trip planner</p>
                        </button>
                        
                        <button class="quick-action-btn p-2 border border-gray-200 rounded-md hover:border-green-400 hover:bg-green-50 transition-all" data-action="performance">
                            <div class="text-lg mb-1">üèÅ</div>
                            <h4 class="font-medium text-sm">Max Performance</h4>
                            <p class="text-xs text-gray-600">Speed & acceleration</p>
                        </button>
                        
                        <button class="quick-action-btn p-2 border border-gray-200 rounded-md hover:border-green-400 hover:bg-green-50 transition-all" onclick="window.location.href='accessories-config.html'">
                            <div class="text-lg mb-1">üîß</div>
                            <h4 class="font-medium text-sm">Accessories</h4>
                            <p class="text-xs text-gray-600">Manage add-ons</p>
                        </button>
                        
                        <button class="quick-action-btn p-2 border border-gray-200 rounded-md hover:border-green-400 hover:bg-green-50 transition-all" onclick="window.location.href='driving-modes.html'">
                            <div class="text-lg mb-1">üéØ</div>
                            <h4 class="font-medium text-sm">Driving Modes</h4>
                            <p class="text-xs text-gray-600">Special scenarios</p>
                        </button>
                        
                        <button class="quick-action-btn p-2 border border-gray-200 rounded-md hover:border-green-400 hover:bg-green-50 transition-all" onclick="window.location.href='mobile-route-map.html'">
                            <div class="text-lg mb-1">üì±</div>
                            <h4 class="font-medium text-sm">Mobile Routes</h4>
                            <p class="text-xs text-gray-600">Mobile mapping</p>
                        </button>
                    </div>


                    <!-- MCP Integration -->
                    <div class="mt-4 p-3 bg-blue-50 rounded-lg">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-blue-400" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd"></path>
                                </svg>
                            </div>
                            <div class="ml-3">
                                <h4 class="text-sm font-medium text-blue-900">AI-Powered Optimization</h4>
                                <p class="text-sm text-blue-700 mt-1">
                                    Our MCP integration analyzes weather, terrain, and your vehicle specs to provide optimal settings.
                                </p>
                                <button id="enable-mcp" class="mt-2 text-sm text-blue-600 hover:text-blue-500 underline">
                                    Configure MCP Connection
                                </button>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-2 border-t border-gray-200 flex justify-between items-center">
                        <button id="back-to-vehicle" class="px-3 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-sm transition-colors">
                            ‚Üê Back
                        </button>
                        <button id="generate-settings" class="px-3 py-2 bg-green-600 text-white rounded-md hover:bg-green-700 focus:outline-none focus:ring-1 focus:ring-green-500 text-sm transition-colors">
                            Generate Optimized Settings
                        </button>
                    </div>
                </div>
            </section>

            <!-- Step 3: Results & Settings -->
            <section id="results-section" class="hidden">
                <!-- Results will be dynamically generated here -->
            </section>

            <!-- Settings & Advanced Features Section -->
            <section id="settings-section" class="hidden">
                <div class="bg-white rounded-md shadow-sm border border-gray-200 p-3 mb-3">
                    <div class="flex items-center justify-between mb-3 pb-2 border-b border-gray-100">
                        <h2 class="text-lg font-bold text-gray-900">Settings & Advanced Features</h2>
                        <button onclick="document.getElementById('settings-section').classList.add('hidden')" class="text-gray-500 hover:text-gray-700 p-1 rounded transition-colors">
                            <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                            </svg>
                        </button>
                    </div>

                    <div class="grid md:grid-cols-2 gap-4">
                        <!-- MCP Integration Settings -->
                        <div class="space-y-4">
                            <div class="bg-gradient-to-r from-purple-600 to-blue-600 rounded-lg p-4 text-white">
                                <div class="flex items-center mb-3">
                                    <span class="text-xl mr-2">ü§ñ</span>
                                    <h3 class="font-bold">Model Context Protocol (MCP)</h3>
                                </div>
                                <p class="text-sm opacity-90 mb-4">
                                    Enhanced AI optimization with advanced context awareness for superior results
                                </p>
                                
                                <div class="space-y-3">
                                    <div class="flex items-center justify-between">
                                        <span class="text-sm">MCP Integration</span>
                                        <label class="relative inline-flex items-center cursor-pointer">
                                            <input type="checkbox" id="mcp-enabled" class="sr-only peer">
                                            <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-blue-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-blue-600"></div>
                                        </label>
                                    </div>
                                    
                                    <button id="configure-mcp" class="w-full bg-white text-purple-600 px-4 py-2 rounded font-semibold hover:bg-gray-100 transition-colors">
                                        Configure MCP Connection
                                    </button>
                                    
                                    <div class="text-xs opacity-75 space-y-1">
                                        <div class="flex items-center">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                            Real-time Analysis
                                        </div>
                                        <div class="flex items-center">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                            Smart Recommendations
                                        </div>
                                        <div class="flex items-center">
                                            <svg class="w-3 h-3 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                                            </svg>
                                            Enhanced Accuracy
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- General Settings -->
                        <div class="space-y-4">
                            <h3 class="font-semibold text-gray-800">General Settings</h3>
                            
                            <div class="space-y-3">
                                <div class="flex items-center justify-between">
                                    <label for="units-system" class="text-sm font-medium text-gray-700">Units System</label>
                                    <select id="units-system" class="border border-gray-300 rounded px-2 py-1 text-sm">
                                        <option value="imperial">Imperial (MPH, ¬∞F)</option>
                                        <option value="metric">Metric (KM/H, ¬∞C)</option>
                                    </select>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <label for="safety-mode" class="text-sm font-medium text-gray-700">Safety Mode</label>
                                    <select id="safety-mode" class="border border-gray-300 rounded px-2 py-1 text-sm">
                                        <option value="conservative">Conservative</option>
                                        <option value="balanced" selected>Balanced</option>
                                        <option value="performance">Performance</option>
                                    </select>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Enable Notifications</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="notifications-enabled" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>
                                
                                <div class="flex items-center justify-between">
                                    <span class="text-sm font-medium text-gray-700">Auto-save Settings</span>
                                    <label class="relative inline-flex items-center cursor-pointer">
                                        <input type="checkbox" id="autosave-enabled" class="sr-only peer" checked>
                                        <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-green-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-green-600"></div>
                                    </label>
                                </div>
                            </div>

                            <div class="pt-4 border-t">
                                <h4 class="font-medium text-gray-700 mb-2">Data & Privacy</h4>
                                <div class="space-y-2 text-sm text-gray-600">
                                    <button class="text-blue-600 hover:underline">Export Settings</button>
                                    <button class="text-blue-600 hover:underline">Import Settings</button>
                                    <button class="text-red-600 hover:underline">Clear All Data</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="mt-4 pt-2 border-t border-gray-200 flex justify-end">
                        <button onclick="document.getElementById('settings-section').classList.add('hidden')" class="px-3 py-2 bg-gray-600 text-white rounded-md hover:bg-gray-700 text-sm transition-colors">
                            Close Settings
                        </button>
                    </div>
                </div>
            </section>
        </div>
    </main>

    <footer class="bg-gray-800 text-white py-2 px-4 mt-4 no-print border-t border-gray-700">
        <div class="container mx-auto text-center text-xs">
            <p>¬© 2024 GEM T2 Smart Optimizer. Not affiliated with GEM, Polaris, or General Electric.</p>
            <p class="mt-1">Use at your own risk. Always follow manufacturer safety guidelines.</p>
        </div>
    </footer>

    <!-- Load JavaScript modules -->
    <script>
        // Set PDF.js worker - ensure PDF.js is loaded first
        document.addEventListener('DOMContentLoaded', function() {
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
                console.log('PDF.js worker configured successfully');
            } else {
                console.error('PDF.js library not loaded - PDFParser functionality will not work');
            }
        });
    </script>
    <!-- Firebase Scripts -->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <script src="js/firebase-config.js"></script>
    <script src="js/firebase-profile-manager.js"></script>
    <script src="js/community-manager.js"></script>
    
    <script src="js/shared-utils.js"></script>
    <script src="js/secure-storage.js"></script>
    <script src="js/api-manager.js"></script>
    <script src="js/tensorflow-ml-engine.js"></script>
    <script src="js/rule-based-optimizer.js"></script>
    <script src="js/optimization-cache.js"></script>
    <script src="js/fallback-calculations.js"></script>
    <script src="js/fallback-system.js"></script>
    <script src="js/api-integration.js"></script>
    <script src="js/mcp-config.js"></script>
    <script src="js/weather-service.js"></script>
    <script src="js/terrain-service.js"></script>
    <script src="js/optimizer.js"></script>
    <script src="js/trip-optimizer.js"></script>
    <script src="js/pdf-parser.js"></script>
    <script src="js/vehicle-classifier.js"></script>
    <script src="js/accessories-manager.js"></script>
    <script src="js/driving-modes.js"></script>
    <script src="js/enhanced-pdf-analyzer.js"></script>
    <script src="js/ai-assistant.js"></script>
    <script src="js/ai-ui-integration.js"></script>
    <script src="js/unified-flow.js"></script>
    
    <script>
        // Enhanced PDF upload and manual entry handlers
        document.addEventListener('DOMContentLoaded', function() {
            const pdfInput = document.getElementById('settings-pdf');
            const pdfAnalysisResult = document.getElementById('settings-input-result');
            const pdfMetadata = document.getElementById('settings-metadata');
            const pdfSettingsPreview = document.getElementById('settings-preview');
            const pdfDebugInfo = document.getElementById('settings-debug-info');

            // Manual entry elements
            const pdfUploadBtn = document.getElementById('pdf-upload-btn');
            const manualEntryBtn = document.getElementById('manual-entry-btn');
            const factoryDefaultsBtn = document.getElementById('factory-defaults-btn');
            const pdfUploadArea = document.getElementById('pdf-upload-area');
            const manualEntryForm = document.getElementById('manual-entry-form');
            const settingsInputResult = document.getElementById('settings-input-result');

            // Factory defaults for GEM T2 Controller
            const factoryDefaults = {
                1: 100,   // MPH Scaling
                3: 15,    // Controlled Acceleration  
                4: 245,   // Max Armature Current Limit
                7: 70,    // Minimum Field Current
                15: 72,   // Battery Volts
                20: 30,   // MPH Overspeed
                24: 50    // Field Weakening Start
            };

            // Settings input mode handlers
            pdfUploadBtn.addEventListener('click', function() {
                hideAllInputMethods();
                pdfUploadArea.classList.remove('hidden');
                setActiveButton(pdfUploadBtn);
            });

            manualEntryBtn.addEventListener('click', function() {
                hideAllInputMethods();
                manualEntryForm.classList.remove('hidden');
                setActiveButton(manualEntryBtn);
                // Pre-fill with factory defaults as placeholders
                populateManualFormDefaults();
            });

            factoryDefaultsBtn.addEventListener('click', function() {
                hideAllInputMethods();
                setActiveButton(factoryDefaultsBtn);
                loadFactoryDefaults();
            });

            // Sample Data Button Handler
            document.getElementById('sample-data-btn').addEventListener('click', function() {
                hideAllInputMethods();
                document.getElementById('sample-data-modal').classList.remove('hidden');
                setActiveButton(document.getElementById('sample-data-btn'));
            });

            document.getElementById('cancel-sample-data').addEventListener('click', function() {
                hideAllInputMethods();
                clearActiveButtons();
            });

            // Cancel buttons
            document.getElementById('cancel-pdf-upload').addEventListener('click', function() {
                hideAllInputMethods();
                clearActiveButtons();
            });

            document.getElementById('cancel-manual-entry').addEventListener('click', function() {
                hideAllInputMethods();
                clearActiveButtons();
                clearManualForm();
            });

            // Save manual entry
            document.getElementById('save-manual-entry').addEventListener('click', function() {
                saveManualEntrySettings();
            });

            function hideAllInputMethods() {
                pdfUploadArea.classList.add('hidden');
                manualEntryForm.classList.add('hidden');
                document.getElementById('sample-data-modal').classList.add('hidden');
                settingsInputResult.classList.add('hidden');
            }

            function setActiveButton(activeBtn) {
                clearActiveButtons();
                activeBtn.classList.add('border-blue-500', 'bg-blue-50');
            }

            function clearActiveButtons() {
                [pdfUploadBtn, manualEntryBtn, factoryDefaultsBtn, document.getElementById('sample-data-btn')].forEach(btn => {
                    btn.classList.remove('border-blue-500', 'bg-blue-50', 'border-green-500', 'bg-green-50', 'border-purple-500', 'bg-purple-50', 'border-orange-500', 'bg-orange-50');
                });
            }

            function populateManualFormDefaults() {
                document.getElementById('manual-f1').placeholder = factoryDefaults[1];
                document.getElementById('manual-f3').placeholder = factoryDefaults[3];
                document.getElementById('manual-f4').placeholder = factoryDefaults[4];
                document.getElementById('manual-f7').placeholder = factoryDefaults[7];
                document.getElementById('manual-f15').placeholder = factoryDefaults[15];
                document.getElementById('manual-f20').placeholder = factoryDefaults[20];
                document.getElementById('manual-f24').placeholder = factoryDefaults[24];
            }

            function clearManualForm() {
                ['manual-f1', 'manual-f3', 'manual-f4', 'manual-f7', 'manual-f15', 'manual-f20', 'manual-f24'].forEach(id => {
                    document.getElementById(id).value = '';
                });
            }

            function loadFactoryDefaults() {
                settingsInputResult.classList.remove('hidden');
                pdfMetadata.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-purple-600">‚úÖ</span>
                        <span class="ml-2 font-medium">Factory Defaults Loaded</span>
                    </div>
                `;
                
                displaySettingsPreview(factoryDefaults, 'Factory Default Settings');
                
                // Store for optimization use
                window.importedSettings = factoryDefaults;
                console.log('Factory defaults loaded:', factoryDefaults);
                
                // Notify unified flow controller
                window.dispatchEvent(new CustomEvent('manualSettingsLoaded', {
                    detail: { settings: factoryDefaults, source: 'factory-defaults' }
                }));
            }

            function saveManualEntrySettings() {
                const settings = {};
                const fields = [
                    { id: 'manual-f1', func: 1 },
                    { id: 'manual-f3', func: 3 },
                    { id: 'manual-f4', func: 4 },
                    { id: 'manual-f7', func: 7 },
                    { id: 'manual-f15', func: 15 },
                    { id: 'manual-f20', func: 20 },
                    { id: 'manual-f24', func: 24 }
                ];

                let enteredCount = 0;
                fields.forEach(field => {
                    const input = document.getElementById(field.id);
                    const value = input.value.trim();
                    if (value !== '') {
                        settings[field.func] = parseInt(value);
                        enteredCount++;
                    } else {
                        // Use factory default if not specified
                        settings[field.func] = factoryDefaults[field.func];
                    }
                });

                settingsInputResult.classList.remove('hidden');
                pdfMetadata.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-blue-600">‚úÖ</span>
                        <span class="ml-2 font-medium">Manual Settings Saved</span>
                    </div>
                    <div class="text-xs text-blue-600 mt-1">
                        ${enteredCount} values entered, ${7 - enteredCount} using defaults
                    </div>
                `;

                displaySettingsPreview(settings, 'Manual Entry Settings');

                // Store for optimization use
                window.importedSettings = settings;
                console.log('Manual settings saved:', settings);

                // Notify unified flow controller
                window.dispatchEvent(new CustomEvent('manualSettingsLoaded', {
                    detail: { settings: settings, source: 'manual' }
                }));

                // Hide the form
                manualEntryForm.classList.add('hidden');
                factoryDefaultsBtn.classList.add('border-blue-500', 'bg-blue-50');
            }

            function displaySettingsPreview(settings, title) {
                const functionNames = {
                    1: 'MPH Scaling',
                    3: 'Controlled Acceleration',
                    4: 'Max Armature Current',
                    7: 'Minimum Field Current',
                    15: 'Battery Volts',
                    20: 'MPH Overspeed',
                    24: 'Field Weakening Start'
                };

                let html = `
                    <div class="bg-white bg-opacity-50 rounded p-2">
                        <div class="font-medium text-xs mb-2">${title}:</div>
                        <div class="grid grid-cols-2 gap-2">
                `;

                Object.entries(settings).forEach(([func, value]) => {
                    const name = functionNames[func] || `Function ${func}`;
                    html += `
                        <div class="flex justify-between items-center text-xs">
                            <span class="font-medium">F.${func} ${name}</span>
                            <span class="text-blue-600">${value}</span>
                        </div>
                    `;
                });

                html += `
                        </div>
                    </div>
                `;

                pdfSettingsPreview.innerHTML = html;
            }
            
            // Sample Data Selection Handler
            window.selectSampleConfig = function(configType) {
                const sampleConfigurations = {
                    'stock_e4': {
                        name: 'Stock GEM e4 (72V Lead-Acid)',
                        description: 'Factory configuration for 4-passenger GEM with standard lead-acid batteries',
                        settings: {
                            1: 100,   // MPH Scaling - Factory default
                            3: 15,    // Controlled Acceleration - Conservative
                            4: 245,   // Max Armature Current - Standard
                            7: 70,    // Minimum Field Current - Factory default
                            15: 72,   // Battery Volts - 72V system
                            20: 30,   // MPH Overspeed - Standard safety margin
                            24: 50    // Field Weakening Start - Conservative
                        }
                    },
                    'lithium_upgrade': {
                        name: 'Lithium Upgrade Setup',
                        description: 'Performance-optimized settings for lithium battery conversion',
                        settings: {
                            1: 135,   // MPH Scaling - Higher for speed
                            3: 25,    // Controlled Acceleration - More aggressive
                            4: 285,   // Max Armature Current - Higher for lithium
                            7: 85,    // Minimum Field Current - Optimized
                            15: 72,   // Battery Volts - Still 72V nominal
                            20: 40,   // MPH Overspeed - Higher margin
                            24: 65    // Field Weakening Start - Performance tuned
                        }
                    },
                    'large_tire_setup': {
                        name: 'Large Tire Setup',
                        description: 'Optimized for 23\"+ tires with adjusted gear ratios and speed scaling',
                        settings: {
                            1: 115,   // MPH Scaling - Adjusted for larger circumference
                            3: 18,    // Controlled Acceleration - Slightly higher
                            4: 260,   // Max Armature Current - Moderate increase
                            7: 75,    // Minimum Field Current - Standard
                            15: 72,   // Battery Volts - 72V system
                            20: 35,   // MPH Overspeed - Moderate
                            24: 55    // Field Weakening Start - Adjusted for tires
                        }
                    },
                    'performance_tuned': {
                        name: 'Performance Tuned',
                        description: 'Aggressive settings for maximum performance and speed',
                        settings: {
                            1: 155,   // MPH Scaling - High performance
                            3: 35,    // Controlled Acceleration - Very aggressive
                            4: 320,   // Max Armature Current - Maximum safe
                            7: 95,    // Minimum Field Current - High performance
                            15: 72,   // Battery Volts - 72V system
                            20: 50,   // MPH Overspeed - High margin
                            24: 75    // Field Weakening Start - Performance max
                        }
                    }
                };
                
                const config = sampleConfigurations[configType];
                if (!config) {
                    console.error('Unknown sample configuration:', configType);
                    return;
                }
                
                // Hide the modal
                document.getElementById('sample-data-modal').classList.add('hidden');
                
                // Show results
                settingsInputResult.classList.remove('hidden');
                pdfMetadata.innerHTML = `
                    <div class="flex items-center">
                        <span class="text-orange-600">‚úÖ</span>
                        <span class="ml-2 font-medium">${config.name} Loaded</span>
                    </div>
                    <div class="text-xs text-orange-600 mt-1">
                        ${config.description}
                    </div>
                `;
                
                displaySettingsPreview(config.settings, config.name);
                
                // Store for optimization use
                window.importedSettings = config.settings;
                console.log(`Sample configuration loaded: ${config.name}`, config.settings);
                
                // Notify unified flow controller
                window.dispatchEvent(new CustomEvent('manualSettingsLoaded', {
                    detail: { settings: config.settings, source: 'sample-data' }
                }));
                
                // Set active button state
                setActiveButton(document.getElementById('sample-data-btn'));
            };
            
            if (pdfInput) {
                pdfInput.addEventListener('change', async function(event) {
                    // Create error boundary for PDF upload handling
                    const errorBoundary = createPDFErrorBoundary();
                    
                    try {
                        const file = event.target.files[0];
                        
                        // Validate file selection
                        if (!file) {
                            console.log('No file selected');
                            return;
                        }
                        
                        // File validation with user-friendly messages
                        if (file.type !== 'application/pdf') {
                            throw new Error(`Invalid file type: ${file.type}. Please select a PDF file.`);
                        }
                        
                        if (file.size === 0) {
                            throw new Error('Selected file is empty. Please choose a valid PDF file.');
                        }
                        
                        if (file.size > 100 * 1024 * 1024) { // 100MB limit
                            throw new Error('File too large (over 100MB). Please select a smaller PDF file.');
                        }
                        
                        console.log('PDF file selected:', file.name, `(${(file.size / 1024).toFixed(1)} KB)`);
                        
                        // Reset UI state safely
                        try {
                            pdfAnalysisResult.classList.add('hidden');
                            clearPreviousResults();
                        } catch (uiError) {
                            console.warn('Unable to reset UI state:', uiError);
                        }
                        
                        // Show loading state with timeout protection
                        const loadingStartTime = Date.now();
                        showPDFLoadingState(file);
                        
                        // Critical dependency validation
                        if (typeof PDFParser === 'undefined') {
                            throw new Error('PDF parsing service is not available. Please refresh the page and try again.');
                        }
                        
                        if (typeof pdfjsLib === 'undefined') {
                            throw new Error('PDF.js library is not loaded. Please refresh the page and try again.');
                        }
                        
                        // Initialize parser with error handling
                        let parser;
                        try {
                            parser = new PDFParser();
                        } catch (initError) {
                            throw new Error(`Failed to initialize PDF parser: ${initError.message}`);
                        }
                        
                        // Add parsing timeout protection
                        const parsePromise = parser.parsePDF(file);
                        const timeoutPromise = new Promise((_, reject) => 
                            setTimeout(() => reject(new Error('PDF processing timed out after 45 seconds')), 45000)
                        );
                        
                        // Execute parsing with timeout
                        const result = await Promise.race([parsePromise, timeoutPromise]);
                        const processingTime = Date.now() - loadingStartTime;
                        
                        console.log(`PDF parsing completed in ${processingTime}ms:`, result);
                        
                        // Validate result structure
                        if (!result || typeof result !== 'object') {
                            throw new Error('Invalid parsing result - parser returned invalid data');
                        }
                        
                        // Handle successful parsing
                        if (result.success) {
                            if (!result.settings || Object.keys(result.settings).length === 0) {
                                throw new Error('PDF parsing succeeded but no settings were extracted');
                            }
                            
                            displayPDFAnalysisSuccess(result);
                            
                            // Store parsed settings safely with validation
                            try {
                                window.importedSettings = { ...result.settings };
                                console.log('Settings stored successfully:', Object.keys(result.settings).length, 'functions');
                                
                                // Dispatch success event for other components
                                window.dispatchEvent(new CustomEvent('pdfSettingsLoaded', {
                                    detail: { 
                                        settings: result.settings, 
                                        source: 'pdf-upload',
                                        confidence: result.metadata?.confidence || 0,
                                        fileName: file.name
                                    }
                                }));
                                
                            } catch (storageError) {
                                console.warn('Failed to store settings:', storageError);
                                throw new Error('Settings extracted successfully but failed to save them');
                            }
                            
                        } else {
                            // Handle parsing failure with detailed error
                            const errorMessage = result.error || 'PDF parsing failed for unknown reason';
                            const errorWithContext = new Error(errorMessage);
                            errorWithContext.pdfResult = result; // Attach full result for detailed error display
                            throw errorWithContext;
                        }
                        
                    } catch (error) {
                        console.error('PDF upload error:', error);
                        
                        // Handle error with comprehensive UI feedback
                        handlePDFUploadError(error, event.target.files[0]);
                        
                        // Clear file input to allow re-selection of same file
                        try {
                            event.target.value = '';
                        } catch (clearError) {
                            console.warn('Unable to clear file input:', clearError);
                        }
                        
                    } finally {
                        // Cleanup and restoration
                        try {
                            hidePDFLoadingState();
                        } catch (cleanupError) {
                            console.warn('Cleanup error:', cleanupError);
                        }
                    }
                });
            }
            
            /**
             * Create error boundary for PDF processing
             */
            function createPDFErrorBoundary() {
                return {
                    handleError: (error, context) => {
                        console.error(`PDF Error in ${context}:`, error);
                        // Could add telemetry or error reporting here
                        return {
                            handled: true,
                            message: error.message || 'Unknown error occurred'
                        };
                    }
                };
            }
            
            /**
             * Clear previous PDF analysis results
             */
            function clearPreviousResults() {
                try {
                    if (pdfMetadata) pdfMetadata.innerHTML = '';
                    if (pdfSettingsPreview) pdfSettingsPreview.innerHTML = '';
                    if (pdfDebugInfo) pdfDebugInfo.innerHTML = '';
                    window.importedSettings = null;
                } catch (error) {
                    console.warn('Error clearing previous results:', error);
                }
            }
            
            /**
             * Show PDF loading state safely
             */
            function showPDFLoadingState(file) {
                try {
                    const fileName = file ? file.name : 'PDF file';
                    const fileSize = file ? `(${(file.size / 1024).toFixed(1)} KB)` : '';
                    
                    if (pdfMetadata) {
                        pdfMetadata.innerHTML = `
                            <div class="flex items-center text-blue-600">
                                <div class="animate-spin rounded-full h-4 w-4 border-b-2 border-blue-600 mr-2"></div>
                                <span>üìÑ Analyzing ${fileName} ${fileSize}...</span>
                            </div>
                        `;
                    }
                    
                    if (pdfAnalysisResult) {
                        pdfAnalysisResult.classList.remove('hidden');
                        pdfAnalysisResult.className = 'mt-2 p-3 bg-blue-50 border border-blue-200 rounded-md';
                    }
                } catch (error) {
                    console.warn('Unable to show loading state:', error);
                }
            }
            
            /**
             * Hide PDF loading state
             */
            function hidePDFLoadingState() {
                // Loading state is replaced by success/error display, so no explicit hiding needed
                // This function exists for consistency and future extensibility
            }
            
            /**
             * Handle PDF upload errors with comprehensive feedback
             */
            function handlePDFUploadError(error, file) {
                try {
                    // Create detailed error information
                    const errorInfo = categorizeUploadError(error, file);
                    
                    // Display error with actionable options
                    displayPDFAnalysisError({
                        error: errorInfo.userMessage,
                        technicalError: error.message,
                        suggestions: errorInfo.suggestions,
                        formatExamples: errorInfo.showFormatExamples ? getBasicFormatExamples() : null,
                        troubleshooting: getBasicTroubleshootingSteps()
                    });
                    
                    // Auto-suggest alternatives
                    setTimeout(() => {
                        suggestPDFAlternatives(errorInfo.errorType);
                    }, 500);
                    
                } catch (handlingError) {
                    console.error('Error handling failed:', handlingError);
                    
                    // Fallback error display
                    try {
                        displayPDFAnalysisError({
                            error: 'PDF processing failed',
                            technicalError: error.message || 'Unknown error',
                            suggestions: [
                                'Try refreshing the page and uploading again',
                                'Use manual entry as an alternative',
                                'Contact support if the problem persists'
                            ]
                        });
                    } catch (fallbackError) {
                        console.error('Even fallback error display failed:', fallbackError);
                        // Last resort: show alert
                        alert('PDF processing failed. Please try manual entry or refresh the page.');
                    }
                }
            }
            
            /**
             * Categorize upload errors for better user guidance
             */
            function categorizeUploadError(error, file) {
                const message = (error.message || '').toLowerCase();
                
                if (message.includes('timeout') || message.includes('timed out')) {
                    return {
                        errorType: 'timeout',
                        userMessage: 'PDF processing took too long and timed out.',
                        suggestions: [
                            'Try a smaller PDF file (current: ' + (file ? (file.size / 1024).toFixed(1) + ' KB' : 'unknown size') + ')',
                            'Ensure stable internet connection',
                            'Use manual entry for immediate access'
                        ]
                    };
                }
                
                if (message.includes('invalid file type')) {
                    return {
                        errorType: 'invalid_type',
                        userMessage: 'The selected file is not a valid PDF.',
                        suggestions: [
                            'Select a file with .pdf extension',
                            'Export directly from GEM programming software',
                            'Convert other formats to PDF first'
                        ]
                    };
                }
                
                if (message.includes('too large') || message.includes('file size')) {
                    return {
                        errorType: 'too_large',
                        userMessage: 'The PDF file is too large to process.',
                        suggestions: [
                            'Compress the PDF to reduce file size',
                            'Export only the settings pages',
                            'Use manual entry for large files'
                        ]
                    };
                }
                
                if (message.includes('no settings') || message.includes('no recognizable')) {
                    return {
                        errorType: 'no_settings',
                        userMessage: 'Could not find controller settings in the PDF.',
                        suggestions: [
                            'Ensure PDF contains function tables (F.1, F.2, etc.)',
                            'Export directly from GEM programming software',
                            'Verify text is selectable (not scanned images)'
                        ],
                        showFormatExamples: true
                    };
                }
                
                if (message.includes('service is not available') || message.includes('parser not available')) {
                    return {
                        errorType: 'service_unavailable',
                        userMessage: 'PDF processing service is temporarily unavailable.',
                        suggestions: [
                            'Refresh the page to reload services',
                            'Check internet connection',
                            'Use manual entry while services restore'
                        ]
                    };
                }
                
                // Generic error
                return {
                    errorType: 'unknown',
                    userMessage: 'An unexpected error occurred while processing the PDF.',
                    suggestions: [
                        'Try refreshing the page',
                        'Ensure PDF is from GEM controller software',
                        'Use manual entry as an alternative',
                        'Contact support if problems continue'
                    ]
                };
            }
            
            /**
             * Suggest PDF alternatives based on error type
             */
            function suggestPDFAlternatives(errorType) {
                try {
                    let suggestionMessage = '';
                    let highlightElement = null;
                    
                    switch (errorType) {
                        case 'timeout':
                        case 'too_large':
                        case 'service_unavailable':
                            suggestionMessage = 'üí° Quick tip: Manual entry only takes 2 minutes for the essential settings!';
                            highlightElement = 'manual-entry-btn';
                            break;
                        case 'no_settings':
                        case 'invalid_type':
                            suggestionMessage = 'üí° Try our sample data to test the optimizer while you prepare your PDF!';
                            highlightElement = 'sample-data-btn';
                            break;
                        default:
                            suggestionMessage = 'üí° Multiple options available: manual entry, factory defaults, or sample data!';
                            highlightElement = 'manual-entry-btn';
                    }
                    
                    // Show notification
                    showNotification(suggestionMessage, 'info', 6000);
                    
                    // Highlight suggested alternative
                    if (highlightElement) {
                        setTimeout(() => {
                            const element = document.getElementById(highlightElement);
                            if (element) {
                                element.classList.add('ring-2', 'ring-blue-400', 'ring-opacity-75', 'bg-blue-50');
                                setTimeout(() => {
                                    element.classList.remove('ring-2', 'ring-blue-400', 'ring-opacity-75', 'bg-blue-50');
                                }, 4000);
                            }
                        }, 1000);
                    }
                    
                } catch (suggestionError) {
                    console.warn('Unable to show suggestions:', suggestionError);
                }
            }
            
            /**
             * Get basic format examples for error display
             */
            function getBasicFormatExamples() {
                return [
                    {
                        title: 'GE Sentry Export Format',
                        description: 'Table with function numbers and values',
                        example: 'F.No.1  MPH Scaling  100\nF.No.3  Acceleration  15\nF.No.4  Max Current  245'
                    },
                    {
                        title: 'Simple Format',
                        description: 'Basic function-value pairs',
                        example: 'F.1  100\nF.3  15\nF.4  245'
                    }
                ];
            }
            
            /**
             * Get basic troubleshooting steps
             */
            function getBasicTroubleshootingSteps() {
                return [
                    { step: 1, title: 'Check PDF Content', description: 'Verify it contains function tables' },
                    { step: 2, title: 'Try Manual Entry', description: 'Enter key settings manually' },
                    { step: 3, title: 'Use Alternatives', description: 'Factory defaults or sample data' }
                ];
            }
            
            /**
             * Show notification helper (if not already defined)
             */
            function showNotification(message, type = 'info', duration = 5000) {
                try {
                    // Create notification element
                    const notification = document.createElement('div');
                    notification.className = `fixed top-4 right-4 z-50 max-w-sm p-3 rounded-md text-sm transition-all transform translate-x-full opacity-0`;
                    
                    // Style based on type
                    switch (type) {
                        case 'error':
                            notification.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-200');
                            break;
                        case 'success':
                            notification.classList.add('bg-green-100', 'text-green-800', 'border', 'border-green-200');
                            break;
                        case 'warning':
                            notification.classList.add('bg-yellow-100', 'text-yellow-800', 'border', 'border-yellow-200');
                            break;
                        default: // info
                            notification.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-200');
                    }
                    
                    notification.textContent = message;
                    document.body.appendChild(notification);
                    
                    // Animate in
                    setTimeout(() => {
                        notification.classList.remove('translate-x-full', 'opacity-0');
                    }, 100);
                    
                    // Animate out and remove
                    setTimeout(() => {
                        notification.classList.add('translate-x-full', 'opacity-0');
                        setTimeout(() => {
                            if (notification.parentNode) {
                                notification.parentNode.removeChild(notification);
                            }
                        }, 300);
                    }, duration);
                    
                } catch (notificationError) {
                    console.warn('Unable to show notification:', notificationError);
                }
            }
            
            function displayPDFAnalysisSuccess(result) {
                // Display metadata
                const metadata = result.metadata;
                pdfMetadata.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <strong>${metadata.fileName}</strong>
                            <span class="text-xs text-gray-600">(${metadata.totalFunctions} functions found)</span>
                        </div>
                        <div class="text-xs">
                            Confidence: <span class="font-medium">${Math.round(metadata.confidence * 100)}%</span>
                        </div>
                    </div>
                    <div class="text-xs text-gray-600 mt-1">
                        Methods: ${metadata.extractionMethods.join(', ')}
                    </div>
                `;
                
                // Display settings preview
                displaySettingsPreview(result.preview);
                
                // Display debug info if available
                if (result.debugInfo && result.debugInfo.detectionResults) {
                    const debugHtml = `
                        <details class="cursor-pointer">
                            <summary class="font-medium">Debug Information (click to expand)</summary>
                            <div class="mt-2 space-y-1">
                                <div>Pages processed: ${metadata.pageCount}</div>
                                <div>Valid functions: ${metadata.validFunctions}</div>
                                <div>Invalid functions: ${metadata.invalidFunctions}</div>
                                <div>Extraction methods used: ${metadata.extractionMethods.length}</div>
                            </div>
                        </details>
                    `;
                    pdfDebugInfo.innerHTML = debugHtml;
                } else {
                    pdfDebugInfo.innerHTML = '';
                }
            }
            
            function displayPDFAnalysisError(result) {
                // Main error message
                pdfMetadata.innerHTML = `
                    <div class="text-red-600">
                        <div class="text-sm font-medium">${result.error || '‚ùå PDF Analysis Failed'}</div>
                        <div class="text-xs mt-1 text-red-500">${result.technicalError || result.guidance || ''}</div>
                    </div>
                `;
                
                // Build comprehensive error display
                let errorContent = '';
                
                // Quick suggestions
                if (result.suggestions && result.suggestions.length > 0) {
                    const suggestionsHtml = result.suggestions.map(s => `<li class="text-xs">${s}</li>`).join('');
                    errorContent += `
                        <div class="mb-4">
                            <div class="text-sm font-medium text-red-800 mb-2">üí° What to try:</div>
                            <ul class="list-disc list-inside space-y-1 text-red-700">${suggestionsHtml}</ul>
                        </div>
                    `;
                }
                
                // Format examples
                if (result.formatExamples && result.formatExamples.length > 0) {
                    errorContent += `
                        <div class="mb-4">
                            <div class="text-sm font-medium text-blue-800 mb-2">üìã Supported PDF Formats:</div>
                            <div class="space-y-2">
                    `;
                    
                    result.formatExamples.forEach(format => {
                        errorContent += `
                            <details class="border border-blue-200 rounded p-2">
                                <summary class="text-xs font-medium text-blue-700 cursor-pointer">${format.title}</summary>
                                <div class="text-xs text-blue-600 mt-1">${format.description}</div>
                                <pre class="text-xs bg-blue-50 p-2 mt-2 rounded overflow-x-auto">${format.example}</pre>
                            </details>
                        `;
                    });
                    
                    errorContent += '</div></div>';
                }
                
                // Troubleshooting steps
                if (result.troubleshooting && result.troubleshooting.length > 0) {
                    errorContent += `
                        <div class="mb-4">
                            <div class="text-sm font-medium text-purple-800 mb-2">üîß Troubleshooting Steps:</div>
                            <div class="space-y-2">
                    `;
                    
                    result.troubleshooting.forEach(step => {
                        errorContent += `
                            <div class="flex text-xs">
                                <span class="flex-shrink-0 w-6 h-6 bg-purple-100 text-purple-800 rounded-full flex items-center justify-center mr-2 text-xs font-bold">${step.step}</span>
                                <div>
                                    <div class="font-medium text-purple-800">${step.title}</div>
                                    <div class="text-purple-600">${step.description}</div>
                                </div>
                            </div>
                        `;
                    });
                    
                    errorContent += '</div></div>';
                }
                
                // Sample PDF download
                errorContent += `
                    <div class="border-t border-gray-200 pt-3">
                        <div class="flex items-center justify-between">
                            <div>
                                <div class="text-sm font-medium text-green-800">üì• Download Sample PDF</div>
                                <div class="text-xs text-green-600">See exactly what format works best</div>
                            </div>
                            <button onclick="downloadSamplePDF()" class="px-3 py-1 bg-green-600 text-white rounded text-xs hover:bg-green-700 transition-colors">
                                Download
                            </button>
                        </div>
                    </div>
                `;
                
                pdfSettingsPreview.innerHTML = errorContent;
                
                // Show fallback info if available
                if (result.fallback && result.fallback.success) {
                    pdfDebugInfo.innerHTML = `
                        <div class="bg-amber-50 border border-amber-200 rounded p-2">
                            <div class="text-amber-800 font-medium text-sm">‚ö†Ô∏è Partial Success</div>
                            <div class="text-amber-700 text-xs mt-1">
                                Fallback extraction found ${Object.keys(result.fallback.settings).length} functions using basic pattern matching
                            </div>
                            <button onclick="acceptFallbackResults()" class="mt-2 px-2 py-1 bg-amber-600 text-white rounded text-xs hover:bg-amber-700 transition-colors">
                                Use These Results
                            </button>
                        </div>
                    `;
                    
                    // Store fallback settings but don't auto-accept
                    window.fallbackSettings = result.fallback.settings;
                } else if (result.fallback && !result.fallback.success) {
                    pdfDebugInfo.innerHTML = `
                        <div class="text-red-600 text-xs">
                            Even basic text extraction failed: ${result.fallback.message || 'Unable to process PDF'}
                        </div>
                    `;
                } else {
                    pdfDebugInfo.innerHTML = '';
                }
            }
            
            function displaySettingsPreview(preview) {
                if (!preview || preview.length === 0) {
                    pdfSettingsPreview.innerHTML = '<div class="text-gray-600">No settings preview available</div>';
                    return;
                }
                
                // Group preview into chunks for better display
                const chunks = [];
                for (let i = 0; i < preview.length; i += 6) {
                    chunks.push(preview.slice(i, i + 6));
                }
                
                const previewHtml = chunks.map(chunk => {
                    const itemsHtml = chunk.map(item => {
                        const rangeText = item.range ? `(${item.range[0]}-${item.range[1]})` : '';
                        const statusClass = item.isInRange ? 'text-green-700' : 'text-red-600';
                        return `
                            <div class="flex justify-between items-center text-xs">
                                <span class="font-medium">F.${item.function}</span>
                                <span class="${statusClass}">${item.value}</span>
                            </div>
                        `;
                    }).join('');
                    
                    return `<div class="grid grid-cols-2 gap-x-4 gap-y-1">${itemsHtml}</div>`;
                }).join('<div class="border-t border-green-200 my-2"></div>');
                
                const showAllButton = preview.length > 12 ? `
                    <button onclick="toggleFullPreview()" class="text-xs text-blue-600 hover:underline mt-2">
                        Show all ${preview.length} functions
                    </button>
                ` : '';
                
                pdfSettingsPreview.innerHTML = `
                    <div class="bg-white bg-opacity-50 rounded p-2">
                        <div class="font-medium text-xs mb-2">Settings Preview (${preview.length} functions):</div>
                        <div id="preview-content">${previewHtml}</div>
                        ${showAllButton}
                    </div>
                `;
            }
            
            // Global function for toggling full preview
            window.toggleFullPreview = function() {
                const fullData = window.currentPreviewData;
                if (!fullData) return;
                
                const content = document.getElementById('preview-content');
                if (content.dataset.expanded === 'true') {
                    // Show condensed version
                    displaySettingsPreview(fullData.slice(0, 12));
                    content.dataset.expanded = 'false';
                } else {
                    // Show full version
                    displaySettingsPreview(fullData);
                    content.dataset.expanded = 'true';
                }
            };

            // Global helper functions for error handling
            window.acceptFallbackResults = function() {
                if (window.fallbackSettings && Object.keys(window.fallbackSettings).length > 0) {
                    window.importedSettings = window.fallbackSettings;
                    
                    // Update UI to show acceptance
                    pdfMetadata.innerHTML = `
                        <div class="text-amber-600">
                            <div class="text-sm font-medium">‚ö†Ô∏è Using Fallback Results</div>
                            <div class="text-xs mt-1">Accepted ${Object.keys(window.fallbackSettings).length} functions from basic pattern matching</div>
                        </div>
                    `;
                    
                    displaySettingsPreview(Object.keys(window.fallbackSettings).map(func => ({
                        function: parseInt(func),
                        value: window.fallbackSettings[func],
                        isInRange: true
                    })));
                    
                    pdfDebugInfo.innerHTML = '<div class="text-green-600 text-xs">‚úÖ Fallback results accepted and ready for optimization</div>';
                    
                    console.log('Fallback PDF results accepted:', window.fallbackSettings);
                }
            };

            window.downloadSamplePDF = function() {
                // Create sample PDF content
                const sampleContent = `GEM T2 Controller Settings Sample

This is an example of the PDF format that works best with our parser.

F.No. Function Description         Counts Value Units
F.No.1  MPH Scaling               100    100   %
F.No.3  Controlled Acceleration   15     15    Amps/Sec  
F.No.4  Max Armature Current      245    245   Amps
F.No.7  Minimum Field Current     70     70    Amps
F.No.15 Battery Volts             72     72    Volts
F.No.20 MPH Overspeed             30     30    %
F.No.24 Field Weakening Start    50     50    %

Alternative Simple Format:
Function  Value
F.1       100
F.3       15
F.4       245
F.7       70
F.15      72
F.20      30
F.24      50

Key Requirements:
- Function numbers should be clearly labeled (F.1, F.No.1, etc.)
- Values should be in a separate column
- Text should be selectable (not scanned images)
- PDF should not be password protected

This sample shows the formats our parser recognizes best.
Export directly from your programming software when possible.`;

                // Create and download the sample file
                const blob = new Blob([sampleContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = 'GEM_T2_Settings_Sample_Format.txt';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                console.log('Sample format file downloaded');
                
                // Show download notification
                const notification = document.createElement('div');
                notification.className = 'fixed top-4 right-4 z-50 px-4 py-2 bg-green-100 text-green-800 border border-green-200 rounded-md text-sm max-w-sm';
                notification.textContent = 'üì• Sample format downloaded! Check your Downloads folder.';
                document.body.appendChild(notification);
                
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 3000);
            };
        });
    </script>
</body>
</html>